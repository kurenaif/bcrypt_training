// references
// https://www.schneier.com/wp-content/uploads/2015/12/constants-2.txt
// https://link.springer.com/chapter/10.1007/3-540-58108-1_24#:~:text=Blowfish%2C%20a%20new%20secret%2Dkey%20block%20cipher%2C%20is%20proposed.&text=The%20block%20size%20is%2064,very%20efficient%20on%20large%20microprocessors.
// https://en.wikipedia.org/wiki/Blowfish_(cipher)
// https://ja.wikipedia.org/wiki/Bcrypt
// https://github.com/libressl-portable/openbsd/blob/master/src/lib/libc/crypt/bcrypt.c
// https://github.com/golang/crypto/blob/5ea612d1eb830b38bc4e914e37f55311eb58adce/blowfish/block.go#L71

mod consts;

use std::mem::swap;
use std::str;

#[derive(Debug,PartialEq)]
pub struct State {
    pub s0: [u32; 256],
    pub s1: [u32; 256],
    pub s2: [u32; 256],
    pub s3: [u32; 256],
    pub p: [u32; 18],
}

pub fn bcrypt(cost: u32, salt: &[u8; 16], password: &[u8]) -> String {
    let state = eks_blowfish_setup(cost, salt, password);
    let ctext = "OrpheanBeholderScryDoubt".as_bytes();

    let mut pos = 0usize;
    let mut res1 = get_next_u64(ctext, &mut pos).unwrap();

    for _ in 0..64 {
        // encrypt with ecb
        res1 = encrypt(&state, res1);
    }

    let mut pos = 8usize;
    let mut res2 = get_next_u64(ctext, &mut pos).unwrap();

    for _ in 0..64 {
        // encrypt with ecb
        res2 = encrypt(&state, res2);
    }

    let mut pos = 16usize;
    let mut res3 = get_next_u64(ctext, &mut pos).unwrap();

    for _ in 0..64 {
        // encrypt with ecb
        res3 = encrypt(&state, res3);
    }

    let res = &[res1.to_be_bytes(), res2.to_be_bytes(), res3.to_be_bytes()].concat()[..23]; // C言語でバグがあったらしく23バイト制限らしい(詳しくはわからん)

    let res_hash = &encode(&res);
    let res_hash = str::from_utf8(&res_hash).unwrap();

    let res_salt = encode(salt);
    let res_salt = str::from_utf8(&res_salt).unwrap();
    
    format!("$2a${:<02}${}{}",cost, res_salt, res_hash)
}

pub fn eks_blowfish_setup(cost: u32, salt: &[u8; 16], password: &[u8]) -> State {
    // C言語ではnull文字が最後に付け加えられるので、その実装に合わせる。
    let password = [password.clone(), &[0]].concat();

    // InitialState
    let mut state = State {
        s0: consts::SBOX0,
        s1: consts::SBOX1,
        s2: consts::SBOX2,
        s3: consts::SBOX3,
        p: consts::PARRAY
    };

    expand_key(&mut state, salt, &password);

    for _ in 0..(1<<cost) {
        expand_key_without_salt(&mut state, &password);
        expand_key_without_salt(&mut state, salt);
    }

    return state
}

/// Extracts 4 bytes from the byte string and converts it to u32. ( If there are not enough bytes, it loops to the first byte. )
///
/// # Arguments
///
/// * `from` - byte array for converting
/// * `pos` - start position for converting
///
/// # Example
///
/// ```
/// use kurebcrypt::*;
/// let byte_array: [u8; 3] = [1, 2, 3];
/// let mut j: usize = 0;
/// let res = get_next_u32(&byte_array, &mut j);
/// assert_eq!(res, Some(0x01020301));
/// assert_eq!(j, 1);
/// ```
pub fn get_next_u32(from: &[u8], pos: &mut usize) -> Option<u32> {
    if *pos >= from.len() {
        return None
    }

    let mut res: u32 = 0;
    for _ in 0..4 {
        res = res << 8 | (from[*pos] as u32);
        *pos += 1;
        if *pos >= from.len() {
            *pos = 0
        }
    }
    Some(res)
}

pub fn get_next_u64(from: &[u8], pos: &mut usize) -> Option<u64> {
    let u64salt_hi = match get_next_u32(from, pos) {
        Some(x) => x as u64,
        None => return None
    };

    let u64salt_lo = match get_next_u32(from, pos) {
        Some(x) => x as u64,
        None => return None
    };
    return Some(u64salt_lo | (u64salt_hi << 32));
}


pub fn split_u64_to_u32(from: u64) -> (u32, u32) {
    let lo = from as u32;
    let hi = (from >> 32) as u32;
    return (lo, hi)
}

// Description of a New Variable-Length Key, 64-Bit Block Cipher (Blowfish) pp.195
pub fn encrypt(state: &State, data: u64) -> u64 {
    let mut xr = data as u32;
    let mut xl = (data >> 32) as u32;

    for i in 0..16 {
        xl = xl ^ state.p[i];
        xr = f(state, xl) ^ xr;
        swap(&mut xl, &mut xr);
    }
    swap(&mut xl, &mut xr);
    xr = xr ^ state.p[16];
    xl = xl ^ state.p[17];

    (xl as u64) << 32 | (xr as u64)
}



// pub fn encrypt(state: &State, data: u64) -> u64 {
//     let mut xr = data as u32;
//     let mut xl = (data >> 32) as u32;

// 	xl ^= state.p[0];
//     for i in 1..9 {
//         xr ^= (((state.s0[(xl>>24) as u8 as usize].wrapping_add(state.s1[(xl>>16) as u8 as usize])) ^ state.s2[(xl>>8) as u8 as usize])).wrapping_add(state.s3[(xl) as u8 as usize]) ^ state.p[i*2-1];
//         xl ^= (((state.s0[(xr>>24) as u8 as usize].wrapping_add(state.s1[(xr>>16) as u8 as usize])) ^ state.s2[(xr>>8) as u8 as usize])).wrapping_add(state.s3[(xr) as u8 as usize]) ^ state.p[i*2];
//     }
// 	xr ^= state.p[17];

//     (xr as u64) << 32 | (xl as u64)
// }

fn f(state: &State, x: u32) -> u32 {
    let a = (x >> 24) as u8;
    let b = (x >> 16) as u8;
    let c = (x >> 8) as u8;
    let d = x as u8;
    ((state.s0[a as usize].wrapping_add(state.s1[b as usize])) ^ state.s2[c as usize]).wrapping_add(state.s3[d as usize])
}                      
                       
pub fn expand_key(state: &mut State, salt: &[u8; 16], password: &[u8]) -> Result<(),&'static str> {
    if password.len() < 1 {
        return Err("password must be at least 1 characters")
    }
    if password.len() > 72 {
        return Err("password must be a string with a maximum length of 72")
    }

    {
        let mut pos = 0usize;
        for i in 0..state.p.len() {
            let word = match get_next_u32(password, &mut pos) {
                Some(x) => x,
                None => return Err("unknown error")
            };
            state.p[i] = state.p[i] ^ word;
        }
    }

    let mut salt_pos = 0;
    let mut block = encrypt(state, get_next_u64(salt, &mut salt_pos).unwrap());
    let (block_lo, block_hi) = split_u64_to_u32(block);
    state.p[0] = block_hi;
    state.p[1] = block_lo;

    for i in 1..9 {
        block = encrypt(&state, block ^ get_next_u64(salt, &mut salt_pos).unwrap());
        let (block_lo, block_hi) = split_u64_to_u32(block);
        state.p[i*2] = block_hi;
        state.p[i*2 + 1] = block_lo;
    }

    for n in 0..128 {
        block = encrypt(&state, block ^ get_next_u64(salt, &mut salt_pos).unwrap());
        let (block_lo, block_hi) = split_u64_to_u32(block);
        state.s0[n*2] = block_hi;
        state.s0[n*2+1] = block_lo;
    }

    for n in 0..128 {
        block = encrypt(&state, block ^ get_next_u64(salt, &mut salt_pos).unwrap());
        let (block_lo, block_hi) = split_u64_to_u32(block);
        state.s1[n*2] = block_hi;
        state.s1[n*2+1] = block_lo;
    }

    for n in 0..128 {
        block = encrypt(&state, block ^ get_next_u64(salt, &mut salt_pos).unwrap());
        let (block_lo, block_hi) = split_u64_to_u32(block);
        state.s2[n*2] = block_hi;
        state.s2[n*2+1] = block_lo;
    }

    for n in 0..128 {
        block = encrypt(&state, block ^ get_next_u64(salt, &mut salt_pos).unwrap());
        let (block_lo, block_hi) = split_u64_to_u32(block);
        state.s3[n*2] = block_hi;
        state.s3[n*2+1] = block_lo;
    }

    Ok(())
}

pub fn expand_key_without_salt(state: &mut State, password: &[u8]) -> Result<(),&'static str> {
    if password.len() < 1 {
        return Err("password must be at least 1 characters")
    }
    if password.len() > 72 {
        return Err("password must be a string with a maximum length of 72")
    }

    {
        let mut pos = 0usize;
        for i in 0..state.p.len() {
            let word = match get_next_u32(password, &mut pos) {
                Some(x) => x,
                None => return Err("unknown error")
            };
            state.p[i] = state.p[i] ^ word;
        }
    }

    let mut block = encrypt(state, 0);
    let (block_lo, block_hi) = split_u64_to_u32(block);
    state.p[0] = block_hi;
    state.p[1] = block_lo;

    for i in 1..9 {
        block = encrypt(&state, block);
        let (block_lo, block_hi) = split_u64_to_u32(block);
        state.p[i*2] = block_hi;
        state.p[i*2 + 1] = block_lo;
    }

    for n in 0..128 {
        block = encrypt(&state, block);
        let (block_lo, block_hi) = split_u64_to_u32(block);
        state.s0[n*2] = block_hi;
        state.s0[n*2+1] = block_lo;
    }

    for n in 0..128 {
        block = encrypt(&state, block);
        let (block_lo, block_hi) = split_u64_to_u32(block);
        state.s1[n*2] = block_hi;
        state.s1[n*2+1] = block_lo;
    }

    for n in 0..128 {
        block = encrypt(&state, block);
        let (block_lo, block_hi) = split_u64_to_u32(block);
        state.s2[n*2] = block_hi;
        state.s2[n*2+1] = block_lo;
    }

    for n in 0..128 {
        block = encrypt(&state, block);
        let (block_lo, block_hi) = split_u64_to_u32(block);
        state.s3[n*2] = block_hi;
        state.s3[n*2+1] = block_lo;
    }

    Ok(())
}

// ref) https://github.com/php/php-src/blob/00aa03bf8e92fc6675da507a1987c077650271d8/ext/standard/crypt_blowfish.c#L412-L442
pub fn encode(message: &[u8]) -> Vec<u8> {
    let mut res = vec![];

    // AAAAAABB BBBBCCCC CCDDDDDD
    for i in (0..message.len()).step_by(3) {
        // (AAAAAA?? >> 2) => AAAAAA
        let a = message[i] >> 2;
        res.push(consts::alphabet[a as usize]);

        let mut b = (message[i] & 0x03) << 4; // (BB << 4) => BB0000
        if i + 1 >= message.len() {
            res.push(consts::alphabet[b as usize]);
            return res;
        }
        b |= message[i+1] >> 4; // BB0000 | (BBBB???? >> 4) = BBBBBB
        res.push(consts::alphabet[b as usize]);

        let mut c = (message[i+1] & 0xf) << 2; // CCCC << 2 => CCCC00
        if i + 2 >= message.len() {
            res.push(consts::alphabet[c as usize]); // CCCC00
            return res;
        }
        c |= message[i+2] >> 6; // CCCC | (CC??????) >> 6 => CCCCCC
        res.push(consts::alphabet[c as usize]);

        let d = message[i+2] & 0x3f; // ??DDDDDD
        res.push(consts::alphabet[d as usize]);
    }
    res
}


#[test]
fn test_get_next_u32() {
    let test_cases = [
        (vec![1u8,2u8,3u8,4u8], 0usize, Some(0x01020304u32)),
        (vec![0u8], 0usize, Some(0u32)),
        (vec![], 0usize, None),
        (vec![0u8], 1usize, None),
    ];

    for test_case in test_cases.iter() { 
        let (byte_array, mut pos, expect) = test_case;
        let res = get_next_u32(byte_array, &mut pos);
        assert_eq!(res, *expect)
    }
}


#[test]
fn test_get_next_u32_continuous() {
    let byte_array = [0x00, 0x00, 0x00, 0x00, 0x00];
    let mut j: usize = 0;
    let res = get_next_u32(&byte_array, &mut j);
    assert_eq!(res, Some(0));
    assert_eq!(j, 4);
    let res = get_next_u32(&byte_array, &mut j);
    assert_eq!(res, Some(0));
    assert_eq!(j, 3);
}

#[test]
fn test_encocde() {
    let test_cases = [
        ("hello".as_bytes(), vec![89u8, 69u8, 84u8, 113u8, 90u8, 69u8, 54u8]),
        ("kurenaif".as_bytes(), vec![89u8, 49u8, 84u8, 119u8, 88u8, 85u8, 51u8, 102u8, 89u8, 85u8, 87u8]),
        ("a".as_bytes(), vec![87, 79]),
        ("".as_bytes(), vec![]),
    ];

    for test_case in test_cases.iter() { 
        let (src, expect) = test_case;
        let res = encode(src);
        assert_eq!(res, *expect);
    }
}

#[test]
fn test_encrypt() {
    let state = State {
        p: [960387255, 1326398754, 3260903289, 2920121373, 3845274305, 3080390474, 4069600420, 554067210, 2727260272, 4220903418, 442256490, 2494798806, 2604680643, 911435233, 3816441971, 3435818500, 380204538, 120047030],
        s0: [751359373, 1911219163, 527677184, 2669081570, 2009405097, 729749346, 66150885, 4244579837, 4251075483, 1947841701, 15049919, 1655821934, 2766381037, 3331885880, 1695477066, 968251674, 497125081, 2914103360, 274441206, 2081137980, 3624692188, 1062986763, 1568980497, 3419857891, 3955235576, 645351812, 3015230633, 3810095814, 3888592165, 3256370071, 1259750282, 4033151479, 2600928875, 3234436737, 2923736285, 1306814549, 3958210431, 3271717644, 1433573837, 953873799, 4030377569, 3390739395, 2187025326, 549477304, 2017302921, 1613756392, 1330963429, 1487619516, 1002888631, 2360353700, 2764831061, 4100224145, 3443667430, 281098437, 1462284183, 1317087972, 1637882647, 3161079928, 3250491301, 4190942830, 2448498903, 907611183, 2900831990, 3120212899, 3488086122, 3720099943, 1489431644, 758785999, 268276634, 2321530413, 3830873712, 495472883, 322537531, 843645427, 3095400323, 1895103923, 3246792287, 2272558441, 3959841203, 4277196845, 792497183, 2462602011, 2263978214, 1719543141, 3575637325, 314732120, 1589017563, 3295077046, 2817594292, 4180218486, 1352786550, 1740808358, 119509601, 642707468, 1850774413, 3331290072, 3534311767, 353242986, 3327637383, 420801871, 3189902675, 4088620128, 2347361737, 698677460, 808492464, 3148057118, 1688640474, 1642951247, 642218461, 2418359295, 80239776, 1577690289, 1822736108, 1712376613, 1019459831, 2712156719, 1384906664, 33681845, 1155256704, 1532774656, 2724583739, 3487479275, 2578492542, 1445266115, 1930136326, 255759862, 2004656077, 2981474443, 2628571556, 213531106, 2378144634, 1044013746, 3884772463, 4008003541, 568370194, 2513105423, 2185887758, 2647513475, 798335349, 2238878598, 4066367910, 3704010150, 1568093122, 178955145, 1509279391, 4153582566, 2356107375, 1656476340, 3208412558, 414446427, 2882607944, 907485428, 1837702622, 4193622870, 2573515129, 2600166902, 441766496, 3907958900, 1926743463, 1681260625, 3682728995, 2890213782, 3329634107, 3770244532, 3935888049, 2545971313, 2512478872, 457354564, 535600806, 4285906984, 3595797281, 3325059185, 2943294276, 561517624, 569084008, 54529554, 1476525924, 296918512, 1204642381, 2391267669, 1483126203, 442286173, 3507289110, 683151604, 535849168, 587990649, 2538223661, 7876960, 4283082820, 1843271316, 285771000, 367446207, 1195372988, 1350719662, 1734575990, 2274270878, 1794762237, 1867924614, 838822957, 1221933223, 106262979, 1689902083, 328578073, 2493063286, 1852404958, 3842886489, 2392759886, 2650859630, 1116196548, 2427662326, 3940307328, 1427759097, 2185658887, 1163027876, 1011256292, 9249511, 1801471055, 607185034, 2910136394, 1843142226, 2187151057, 392784349, 4018749244, 1697737784, 1946198907, 2183679930, 717192117, 979710424, 1005345861, 2781750481, 2956008192, 2969105983, 2651531188, 1327203827, 422966488, 395453349, 4120541482, 2126568526, 2870308692, 1905241460, 1780882275, 2641054, 2454041072, 1583097502, 4144745871, 2739979904, 3731086783, 2754941132, 1077991004, 2444731016, 1897043833, 2670225031, 2173045424, 1823610417, 3178993478, 2690622855],
        s1: [3962496606, 2552508630, 222515264, 3582403971, 2804457519, 1186238500, 4040644044, 2351916121, 2601971773, 1422432953, 545345040, 2642555427, 125911197, 2735802214, 1641227958, 363712385, 1762793487, 4144937169, 412693513, 2733978362, 313337882, 961978804, 2057209547, 3657364676, 3861782356, 4076739492, 1341013742, 1619923638, 1539487048, 4202189690, 2496971851, 1017918000, 3318146804, 228361174, 2591886594, 938741573, 1086271298, 84318165, 3719105768, 2552427558, 3563830623, 1274469928, 2830176264, 2891671865, 897496629, 3671845848, 2651226378, 232847642, 3843909712, 1405711374, 4026171531, 619634912, 1142171363, 2238988845, 395367975, 454862749, 1456034678, 819618581, 1324668599, 1224521749, 2786259809, 143010138, 4166378310, 1598368753, 1728176732, 80719579, 3840322580, 2553734025, 241224664, 201798936, 3804694561, 2574506555, 3913916379, 1116035469, 783558355, 1652623649, 155340220, 303346435, 1109758292, 3310855117, 3591172608, 3874994581, 3499868595, 2661429902, 2049953651, 3315376208, 3736451197, 481754802, 1167769850, 1181710638, 415151967, 3989237540, 1243799551, 3157915884, 1480514344, 1692094754, 2250382894, 3335586101, 4120813474, 2477760579, 249695838, 33785352, 899032694, 1172217604, 3588974131, 1259558299, 414891780, 2582088500, 2661153594, 404976735, 4018187998, 702904095, 925995571, 2304049896, 3026200956, 394229630, 32577249, 61990858, 283702905, 3948257859, 713855766, 3151292791, 580422252, 3132370473, 2342554365, 3730351923, 4209807019, 3772071699, 3293959668, 3662323641, 3802976970, 2816777175, 1139474211, 4003171461, 1956907662, 4254884147, 4294133976, 1705679575, 3391177912, 403819195, 3064730920, 1716554991, 1195212409, 1168482116, 3327508741, 3223311286, 3462595387, 2080178200, 279433081, 174440574, 3352350727, 2367659382, 3646371245, 1928581568, 2397960873, 4275169891, 4187077828, 540407125, 1562933564, 1166240133, 1380119816, 2727414763, 1736215523, 4226091473, 849805087, 510719666, 3334611835, 274490044, 3187593504, 369193352, 2223471375, 604305504, 1229729647, 144991784, 3158539392, 2299573150, 3295702799, 655653018, 4045919999, 1788357037, 3608953741, 645102547, 1416351814, 285617880, 3968675319, 1096843476, 2384883511, 1687389758, 3973249456, 3814566887, 3925871421, 2151913806, 2285296547, 1029399185, 328833279, 567878735, 703080618, 4249068939, 1134548749, 2790616170, 2005390767, 219726046, 1464845377, 2366943447, 3010997628, 3809552131, 2764756729, 2713096324, 2147868695, 4243462390, 4058067423, 2648706567, 1337215927, 1815518780, 4051730534, 3101485965, 2827637369, 3117795056, 1481329097, 3808647903, 3161220914, 724729296, 1552304935, 3157865557, 2869349817, 2916215632, 526888490, 3716040013, 353093815, 985012460, 2988822823, 2018999046, 114273730, 424095540, 3626846947, 1813046020, 549911021, 2450120110, 1048851768, 2826456503, 3355549968, 528705553, 1303371162, 2062335363, 1083697445, 1526925516, 3416814274, 3149503049, 3710361025, 376540582, 1427790221, 208982209, 3971476064, 3683554035, 101274604, 526517001],
        s2: [3685627420, 283257260, 1307490422, 221944528, 1993112682, 2201606544, 3903061989, 1252847488, 1004609235, 890577980, 1102909118, 3889491091, 580323624, 3888668565, 3085850073, 3215509807, 3915987791, 4017985969, 2348265632, 1436524367, 2635969236, 3111264386, 2414551693, 1636703225, 1271300427, 4028508949, 2833621234, 440166776, 3823533275, 125547553, 4098542868, 4023206491, 3474693450, 4098334254, 1512006521, 901832118, 1744676275, 3548227353, 1141595543, 1768025375, 3667342943, 1089967361, 794530069, 386216310, 30479815, 974474400, 699512230, 2756811907, 2721179959, 257710782, 3713828105, 1437079773, 297372929, 4111060683, 382050131, 303181113, 3754106993, 1604691903, 1394522882, 3508891855, 1536966561, 3280943270, 4226578717, 2393064390, 1792763813, 2101442859, 89352651, 1071713142, 1150564725, 1830934130, 4014117514, 1521720041, 1602593328, 231472306, 204085419, 1137504026, 3033804805, 3028201059, 24425569, 796322949, 3954049391, 1593439311, 1013190970, 61630914, 43420150, 42024804, 790868153, 1279275373, 2270406383, 1819700563, 226924228, 3721125138, 2693655083, 3223207991, 533840600, 3468326096, 4212966299, 3112480374, 2519843792, 1826222951, 2251058409, 212091378, 1409614329, 2212865350, 406143943, 965398700, 3224077225, 2637045624, 24239588, 588019672, 265324223, 2854979512, 2495238091, 3584118028, 1319283667, 1423349420, 1488220412, 3156007823, 1172950025, 1096432458, 4039031271, 3882368782, 2579874423, 234678667, 173971341, 2790152840, 1130648232, 3848282037, 2006676167, 785328744, 4128898217, 1332904739, 2099250375, 158546208, 119865937, 4174610581, 1010060521, 853243873, 3267818235, 808876710, 1949995479, 1241421430, 2516538691, 3583342729, 2698150010, 4097625964, 3840390700, 3470689394, 2553760595, 2060594845, 2958559175, 2116407437, 312638317, 2310054785, 1385515620, 1378096018, 1027615097, 1445945703, 3108836515, 3103922174, 4011089680, 1964138368, 1005488690, 2453683526, 2175045869, 2829162940, 4189560507, 2433539853, 2272185927, 1877827865, 1187444704, 2436279572, 409376661, 3357284546, 1984658081, 2377658472, 2436455049, 423950495, 1691385143, 3669794118, 637150503, 3647475868, 2927104663, 992086376, 2539687282, 888099503, 1598299211, 1799928638, 1228665421, 2273804068, 1115658275, 2143587859, 1595400394, 3796549812, 1783913498, 1492572840, 2013214876, 107424075, 796714868, 44515025, 269318579, 3952378672, 1474024361, 2438560873, 315299687, 1032114545, 2601134415, 667247245, 2665530964, 1609190326, 3008433471, 2774780060, 1934725931, 3354571878, 1112264762, 3804012390, 1311192607, 3407311175, 2226580228, 4022278187, 1512416562, 2670556501, 3245730218, 2701029024, 3033083350, 2087911248, 2584296289, 4106951518, 3829881038, 3181042549, 1358373811, 1246114361, 2701159509, 1307770910, 3059347414, 2594013556, 158862869, 1001875314, 1233324028, 691505761, 2226616826, 567074033, 964276726, 1692433609, 832219072, 4231138557, 1273438392, 3479079679, 2798056815, 3260250354, 3782917383, 2013046838, 1827450148, 172008005, 883567517, 1589237711],
        s3: [84759111, 3262702768, 3415301105, 3498683982, 1806500368, 1425319193, 1472304172, 74674307, 1230400825, 4189778135, 3704989578, 2787466472, 2954396438, 527602333, 2840318508, 925495642, 768531679, 1202717585, 4256924484, 4126776357, 774327013, 2474928946, 2934716214, 4076028696, 1185929969, 520385101, 2331066174, 3702855488, 3157194994, 1400026809, 3183103004, 3997395841, 725527464, 3521588893, 2635112993, 3866446662, 2968353960, 607037316, 40648425, 891050943, 1604951499, 1996687073, 2080634266, 3480439703, 763831655, 2817425755, 3841065428, 727834143, 1275857414, 3594921046, 2142990827, 3099540514, 3415965085, 1501032123, 2122609375, 348413122, 196445717, 1637427467, 3911606188, 3694337409, 864261711, 2186312749, 1094067124, 1632845555, 4098705097, 2339412576, 2494400846, 833770154, 3158578307, 4010859890, 3484444264, 3143409848, 983905658, 3437176874, 3121812841, 272773918, 3123927979, 2586357552, 574019862, 1772662464, 3823827764, 2409179452, 2068095815, 1612005033, 503394576, 2528526117, 815443612, 1028822502, 487240786, 3200847844, 843928357, 3189859270, 4107138296, 3049907173, 1547833601, 3231861593, 364655566, 2111371701, 3326771650, 1830332040, 2850190400, 2159194433, 808038895, 68148975, 478673726, 211800080, 1345056815, 2187115125, 3302249696, 806234965, 779445231, 1652239876, 890666980, 4082298281, 1939725165, 1330146288, 3238984746, 2732596984, 2916723342, 1672631159, 853901782, 2861934109, 1289855665, 82648941, 2783383209, 1573548653, 1395766733, 405142433, 572041807, 1055612848, 1419013391, 2883620447, 1598711710, 300381041, 568188790, 3104900997, 1613816486, 2825850837, 4225388613, 3357113916, 8878598, 2454027904, 2566317048, 216550415, 745967593, 3556290733, 2107695390, 1609749594, 1924784573, 3178039535, 3734642787, 2893496208, 1242032474, 2595434836, 2547521915, 3254258156, 543931237, 3784217054, 2357593656, 2413447429, 2753581456, 3262687437, 1009751023, 555563296, 1058470773, 2836915311, 2502951802, 2633724524, 2581214084, 2953676085, 2718688451, 3893942462, 2573746868, 1813121025, 180187643, 1331709241, 2061273165, 1140298244, 1103804087, 1207650037, 4094055730, 921021473, 2411241099, 4279844584, 1263293648, 1581212750, 3723662096, 2222721793, 3098716864, 3003265979, 2093061828, 3487419568, 3996574218, 396020977, 3039732243, 2261665091, 690914946, 3714429948, 99761742, 233717755, 783564800, 1560685380, 2235163239, 2378935054, 2693616688, 3780077013, 1566412032, 1264476395, 2712542660, 670519187, 1471879859, 885825868, 422834064, 2012549931, 2480300966, 1527437015, 1895856530, 1186445316, 2453357391, 1178414621, 2985326555, 2432579646, 1771120441, 3798818790, 2156987799, 3215223273, 722733568, 1055923389, 1027237683, 1849935838, 2161268991, 2381563183, 2253659048, 2532778422, 1366542490, 1556257565, 1947849506, 3328946959, 3737936767, 3428936422, 2406820394, 1017652977, 3207940882, 2191896800, 3248390212, 3332163952, 4088114401, 585938406, 3458677131, 1885106684, 2078372879, 1828742801, 4003157356, 3845316270, 1522199472, 2596050418]
    };

    let l = 701283071u64;
    let r = 3522073065u64;
    let xl = 216138454u64;
    let xr = 525185671u64;

    let src = (l << 32) + r;
    let expect = (xl << 32) + xr;

    assert_eq!(encrypt(&state, src), expect);
}

#[test]
fn test_expand_key_without_salt() {
    // InitialState
    let mut state = State {
        p:  [2798345663, 3115745837, 2763382015, 1749406558, 976822291, 523064496, 3184405352, 907279524, 558847559, 126704181, 1995809897, 2345914700, 1472880934, 2841018953, 2847203361, 3185113695, 1142202220, 2630248292], 
        s0: [676454462, 1272271786, 873539675, 2686839465, 346506097, 80399275, 589438928, 3546369867, 1744143904, 798926874, 1391086939, 682941477, 1578622682, 401097679, 2024993445, 1417445980, 4177508923, 890062054, 1064000466, 1647720969, 1490177189, 1167966610, 2264910206, 2923843517, 215363410, 2282976449, 3801510020, 1564045162, 3629947254, 3727846370, 2556094668, 2505563232, 2855160700, 3770533416, 3427686803, 4016995316, 512427023, 3911203205, 2520226884, 1362267430, 1381137896, 4042378721, 2541622922, 1244669430, 599905514, 1624484630, 4072573318, 1138704991, 2339750700, 2162812977, 395230942, 2230326491, 2465044422, 3784799856, 1750276821, 2295856874, 3426829462, 3720468502, 2135801387, 2887582192, 3109909476, 2456150104, 3845483894, 1422107140, 595793670, 847786699, 2605084776, 856482520, 673871047, 3405181999, 3772409383, 590060505, 3462290958, 872190849, 1202270770, 3247173893, 1157753935, 1621706027, 876563378, 3052551887, 3582498882, 2197894774, 2265681996, 2936446246, 212240664, 1150253480, 2706019237, 416678421, 2865927298, 1619962987, 3453808263, 3394098819, 2181706984, 161189268, 1087269757, 1408120018, 3555862541, 3890496653, 1622583788, 1201082517, 13325912, 2481323395, 2886997398, 582438366, 10752657, 897241492, 213153084, 1339012003, 2069764703, 193873211, 3148224487, 4148882944, 4062906972, 1245900973, 3977317393, 516503615, 2240484896, 3877270803, 3944895778, 2457151727, 1961223094, 1719245248, 985802346, 3757149277, 158778694, 1747466634, 2538774909, 4168471760, 1009630408, 2020491438, 2342975169, 946066840, 2450061377, 1699508125, 1676930974, 4066196740, 4027983924, 2089520038, 1959644623, 2794884420, 1507899473, 3020273735, 1188587956, 1995449644, 2296724221, 468242640, 545940833, 755575733, 880500553, 2220431864, 1539270408, 3630768707, 3795475511, 4209806151, 1323022845, 320768024, 1807049611, 980508812, 3531533438, 3165506942, 2340160596, 797871149, 1328658604, 1462603394, 3400811938, 671157969, 3238724695, 3803045339, 4173818433, 4039602328, 4028597456, 2394262622, 4109411345, 3230436700, 2761214522, 2041596342, 3713248210, 3064615133, 1966874445, 1633610046, 3310483970, 3305576161, 3575359423, 3568886912, 1009790447, 1642127506, 2457607754, 2532309753, 1155636415, 1536221689, 4238025853, 2499952280, 1990575775, 3242602078, 2733057994, 3402500736, 4248247392, 3100143292, 2419329322, 1561780075, 656363637, 2059510138, 3767462873, 1109331618, 3838620982, 799019198, 1106642236, 210589368, 2641788265, 3850512603, 3423250279, 3750610059, 3402867847, 2058330547, 2000711402, 1301080353, 392514224, 3375686461, 291108565, 3765240868, 2709332991, 1397411465, 338171739, 824750237, 637342327, 2117562810, 2978388429, 3743659775, 1599543927, 717482022, 370245568, 2584857805, 1833958769, 1850300501, 1198012449, 660140659, 1235446080, 3782618883, 431355351, 2258602910, 3585404750, 3266561928, 254601067, 3951737387, 3828621245, 441640376, 642288526, 1207120745, 1502726064, 2384308763, 4159010288, 2267249720, 1638774133, 2987030575, 162935479, 1200247442], 
        s1: [472083812, 3770068924, 3074822563, 1394638570, 2018825446, 1545052392, 2759523341, 2303311498, 3702742967, 3395724093, 160530801, 3162941321, 108239659, 497607001, 3984001488, 3855678334, 1385193553, 1283570665, 563810886, 2744781965, 2037448858, 4072755815, 1130048568, 1161225846, 3923783090, 2244609586, 2758115005, 972586975, 2994878506, 2335626542, 1222161726, 3575998520, 1811591414, 688489649, 3616227426, 3848634866, 2687180076, 3369171229, 3489648410, 4109761960, 1979793800, 1639610142, 3894504781, 1935786209, 1137045381, 1357340853, 511746915, 2965293695, 4088114496, 274179101, 209783419, 2601040942, 1166602590, 970463802, 55401265, 1957366110, 2441834901, 4243751280, 2828724468, 1057010323, 347987147, 751488028, 2896578520, 1715167967, 1879210500, 3744571943, 1185917501, 3675757271, 3343686823, 956694973, 3886903973, 3377797106, 2357771222, 1201633320, 3111334010, 259874874, 1094725687, 4166366972, 757063657, 1653946250, 63407545, 904858797, 1832511644, 3700840539, 1986739777, 2957115747, 3554612275, 545713679, 2834593402, 1950223834, 512841807, 817078044, 1441861257, 1086178079, 2849597330, 2276442937, 2639342265, 2969233466, 3205632041, 2550514228, 3779069632, 1101862162, 1461055711, 1901975352, 2148999055, 1249638228, 1350882448, 991791964, 1820699849, 3305872710, 79273359, 2977191022, 4088126989, 2566924723, 219721535, 3660703706, 4280578078, 2411372537, 3074400355, 1172161233, 2289293138, 3026389107, 809380459, 4204707391, 528056201, 685214699, 375865914, 245008467, 2578197650, 2887311787, 4174158394, 3969295308, 503822146, 1633335771, 1276824390, 2980955141, 2150986213, 3138745685, 1190295702, 1294220900, 1696759029, 677819787, 2640120040, 3695687532, 3347843687, 196624891, 2012397063, 914232896, 263182696, 4255683727, 1429031079, 1097467998, 424953395, 1065731215, 43704444, 1400758775, 3139714064, 2700405497, 1575344090, 1311475223, 3310906608, 3426033111, 1837813496, 1100828187, 3761789251, 1042029661, 3014880156, 1039817220, 1426312212, 3124688189, 519510957, 4102485857, 1750901621, 3292710582, 4023532517, 690834380, 2025093781, 3675008004, 3912948477, 3363849698, 230551464, 3259085937, 2799086180, 2752228053, 3465947293, 3528386667, 1271741700, 553212838, 1717392035, 281395822, 2430583899, 1872973280, 118285136, 1717347996, 3281069787, 233679973, 1699453913, 3437232145, 686047307, 1863873988, 1012733795, 3277841047, 1309962133, 3392045945, 3271264563, 3160473246, 2210226009, 3614952385, 3302658752, 2433634201, 3655259080, 437840847, 3153048205, 1583554996, 1568000745, 3975017185, 3346426236, 2565139829, 1837068378, 3063369513, 1571453132, 2064559192, 1085836357, 3267641108, 3845033331, 1201488240, 201428592, 2479505812, 1945014716, 3231625898, 532586551, 193379039, 2835709134, 1293194257, 3342170242, 1139754580, 3897799688, 1685600441, 1250982870, 1808707925, 3855802002, 2950876679, 468455925, 3756271425, 1737879444, 63597990, 368933745, 2065537199, 3980218754, 3805214281, 272723093, 2150910972, 871152404, 158127437, 1690237187, 927392735], 
        s2: [2030326932, 2507010455, 26158438, 3725388351, 2827182470, 4003922793, 834815126, 625710034, 3685449788, 4100294130, 1803019407, 4200828846, 4019237533, 1065582197, 1008134547, 1277516665, 3248993370, 4091513230, 2254758447, 889650927, 3857002503, 1810437854, 2693574866, 2153178087, 2526675297, 292778563, 2414198035, 2134368959, 3087955945, 2069083953, 3965701497, 1206199560, 3146429849, 968450073, 2069776255, 1911534690, 909933859, 2304242151, 1065811415, 1335555609, 3341927736, 3948476544, 4244228698, 270363479, 2783221329, 4216729437, 217572709, 4151157255, 698017677, 3246721908, 384431049, 4130797755, 1690322415, 897481564, 1587130138, 2558439988, 3504544659, 3187557190, 3128660588, 797093593, 4089651264, 2438984586, 1202012945, 3856974218, 298101502, 4196327919, 3053067125, 4149446696, 4150214910, 525539971, 2862528890, 4139338054, 3383699189, 2516470702, 2342477462, 1930074435, 2458317393, 4294173046, 2232132528, 3163216971, 1148393569, 1533976930, 2461998106, 3187382800, 2908101331, 2173866850, 2716034867, 3315171691, 2226484691, 1129677529, 3032691043, 3747691609, 382317315, 2415638257, 1069529056, 2599207624, 1601615811, 2462391962, 545160938, 2060161592, 2065802002, 2005979921, 197889807, 2349970015, 4137964465, 3209705719, 2547085506, 3215155239, 4203071631, 23539487, 785833022, 608716249, 323605815, 3470461295, 582077769, 2014866809, 3276389219, 2542666213, 2954548574, 1208429978, 695367851, 3861383595, 4119580400, 853482003, 1937150713, 3017236889, 1256531801, 476432355, 171553789, 3666343247, 1093329128, 3155591722, 1836731114, 587515344, 1296896133, 2940519146, 2241994447, 659122235, 115224071, 336870305, 2278874910, 1003897532, 2961589262, 563227713, 1506881705, 59364574, 3185138194, 948354866, 2604640349, 1889095203, 3875814229, 1555249954, 385718770, 2473809579, 3473451448, 775784206, 1339279198, 3118846800, 4187284313, 2139224444, 3579127849, 1759057686, 1027665254, 3550009772, 1748616252, 4094256760, 1705159032, 929888260, 650181553, 1305356803, 3075799978, 3069245053, 397890611, 1182603630, 583738411, 1516215248, 176785336, 3801891317, 1825933230, 3513410704, 3659920259, 2033876061, 3185876042, 2547054828, 3838441518, 2053794257, 3582741925, 2768950096, 821526076, 1709927365, 768450230, 2092381618, 1976840479, 4041788251, 1454737280, 1891915899, 1423376867, 253761025, 2454386056, 291500795, 4213297989, 1548710689, 1503794241, 2050726474, 3978427262, 3692476685, 2756987704, 1221368249, 773460215, 1337618276, 3867562030, 3882723728, 4131048417, 485412475, 934897990, 3707735453, 3639623222, 3931679494, 3938395040, 4290140595, 3737516535, 1247404677, 3311241978, 2182947631, 1098880326, 645797237, 4191674413, 4097321855, 2732354876, 3941919033, 2931130202, 942824492, 1769446651, 2192528067, 893852461, 3808612987, 4037091546, 501924547, 2086518919, 1225876766, 4240082102, 2988552152, 3546910021, 1673855783, 2508076715, 2739637838, 3971817978, 1029745465, 3518641506, 4096350064, 787534034, 1732927643, 1853386857, 3297877548, 707223568, 4252216022], 
        s3: [3066661050, 616624353, 3714240339, 2123856950, 3647589697, 2065091598, 3916682196, 1117923124, 204986545, 3772252588, 1683898358, 303044025, 587684464, 1042315361, 1228195799, 878423328, 3394392353, 3690724543, 4290544724, 3791164033, 1256286035, 2379735913, 1928550058, 2701921634, 4240462192, 1146079557, 2846198727, 348020271, 3635687465, 2540981783, 409071058, 939175611, 1612444618, 535072600, 4149748582, 2297417044, 4087944708, 964923342, 712583697, 2571436424, 417254762, 2145460236, 2914748355, 1635323191, 3752683464, 3588426158, 1092004328, 2807104745, 2050327913, 1731863032, 1005587188, 3614235807, 4249202537, 308310017, 791496523, 1816478894, 2459740329, 2213651052, 362992044, 398325613, 3964562366, 2098184129, 1782438174, 3167040350, 1348491680, 1920345890, 1768033492, 2841696288, 2664173426, 3792318204, 594520090, 4082840818, 2588617739, 4206593349, 109216885, 3929832197, 2367599721, 1011173935, 2869241790, 3115713945, 3040285683, 2312346021, 63517398, 472670920, 816663545, 1434975673, 1432719557, 2403982718, 912511206, 1688934500, 630376069, 1449091312, 1111886186, 153355290, 2763348214, 988124280, 3787827508, 3221168641, 2167312778, 133348070, 4148354988, 3041645215, 984362080, 464899793, 2763767977, 2695568023, 325049632, 1384378150, 3826507421, 3618639460, 4164111275, 2141832091, 3965800451, 2910159612, 4124981534, 812537540, 3909662663, 4116672622, 182676213, 3287478828, 3787621702, 330417357, 1970377712, 69979522, 2802445684, 1731524165, 3342386089, 649219836, 1191381588, 370953469, 1900215824, 3269090184, 3414087909, 1539404925, 667055825, 2651756559, 3483045960, 699250037, 4140048949, 2903011680, 1273453137, 2268744142, 1879434333, 2415032771, 1658649626, 2184411515, 4196565192, 2919973049, 2385396446, 3843219659, 3190409174, 2524833398, 2469946839, 1072560449, 1247479917, 313762972, 1431894384, 2688661138, 2936734737, 2545127803, 1935150612, 576607727, 3440356694, 3473529451, 28603187, 1625577492, 197530943, 2263048709, 1964272476, 3951756983, 4240229901, 1225608669, 443063074, 3234264370, 2412682271, 89866350, 2410002888, 786106098, 1555281734, 2043145870, 1344858128, 832945983, 4116832824, 3478609432, 568797872, 642337479, 545505301, 3324300504, 2718404481, 2864851459, 533053047, 4251752963, 3922453058, 2952815718, 3684001648, 732886525, 2713385656, 4294817441, 859974804, 41613898, 3142141051, 391438393, 33207016, 2441505303, 3972312780, 2099509232, 2060782456, 3843747884, 1012529053, 454711185, 3706767884, 2717301540, 1611874958, 677450684, 3551945381, 3335043585, 1445510024, 55025254, 2612843815, 2018984302, 1982199960, 1344358604, 818293842, 199452997, 1418842826, 372010568, 1324655810, 3566108610, 2174581593, 2355572514, 1719951393, 1694109702, 44666143, 1035251619, 2439580380, 3491386156, 4024180401, 3027851172, 3374794167, 1396685722, 1095727557, 88817600, 1643725439, 380382781, 1993820899, 1159368263, 2253971990, 3272533893, 3993679260, 1008667172, 3149491687, 597395917, 717383847, 3142131801, 644903399, 1725658750], 
    };

    let key: [u8; 16] = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];

    expand_key_without_salt(&mut state, &key);

    let expect = State {
        p: [960387255, 1326398754, 3260903289, 2920121373, 3845274305, 3080390474, 4069600420, 554067210, 2727260272, 4220903418, 442256490, 2494798806, 2604680643, 911435233, 3816441971, 3435818500, 380204538, 120047030], 
        s0: [751359373, 1911219163, 527677184, 2669081570, 2009405097, 729749346, 66150885, 4244579837, 4251075483, 1947841701, 15049919, 1655821934, 2766381037, 3331885880, 1695477066, 968251674, 497125081, 2914103360, 274441206, 2081137980, 3624692188, 1062986763, 1568980497, 3419857891, 3955235576, 645351812, 3015230633, 3810095814, 3888592165, 3256370071, 1259750282, 4033151479, 2600928875, 3234436737, 2923736285, 1306814549, 3958210431, 3271717644, 1433573837, 953873799, 4030377569, 3390739395, 2187025326, 549477304, 2017302921, 1613756392, 1330963429, 1487619516, 1002888631, 2360353700, 2764831061, 4100224145, 3443667430, 281098437, 1462284183, 1317087972, 1637882647, 3161079928, 3250491301, 4190942830, 2448498903, 907611183, 2900831990, 3120212899, 3488086122, 3720099943, 1489431644, 758785999, 268276634, 2321530413, 3830873712, 495472883, 322537531, 843645427, 3095400323, 1895103923, 3246792287, 2272558441, 3959841203, 4277196845, 792497183, 2462602011, 2263978214, 1719543141, 3575637325, 314732120, 1589017563, 3295077046, 2817594292, 4180218486, 1352786550, 1740808358, 119509601, 642707468, 1850774413, 3331290072, 3534311767, 353242986, 3327637383, 420801871, 3189902675, 4088620128, 2347361737, 698677460, 808492464, 3148057118, 1688640474, 1642951247, 642218461, 2418359295, 80239776, 1577690289, 1822736108, 1712376613, 1019459831, 2712156719, 1384906664, 33681845, 1155256704, 1532774656, 2724583739, 3487479275, 2578492542, 1445266115, 1930136326, 255759862, 2004656077, 2981474443, 2628571556, 213531106, 2378144634, 1044013746, 3884772463, 4008003541, 568370194, 2513105423, 2185887758, 2647513475, 798335349, 2238878598, 4066367910, 3704010150, 1568093122, 178955145, 1509279391, 4153582566, 2356107375, 1656476340, 3208412558, 414446427, 2882607944, 907485428, 1837702622, 4193622870, 2573515129, 2600166902, 441766496, 3907958900, 1926743463, 1681260625, 3682728995, 2890213782, 3329634107, 3770244532, 3935888049, 2545971313, 2512478872, 457354564, 535600806, 4285906984, 3595797281, 3325059185, 2943294276, 561517624, 569084008, 54529554, 1476525924, 296918512, 1204642381, 2391267669, 1483126203, 442286173, 3507289110, 683151604, 535849168, 587990649, 2538223661, 7876960, 4283082820, 1843271316, 285771000, 367446207, 1195372988, 1350719662, 1734575990, 2274270878, 1794762237, 1867924614, 838822957, 1221933223, 106262979, 1689902083, 328578073, 2493063286, 1852404958, 3842886489, 2392759886, 2650859630, 1116196548, 2427662326, 3940307328, 1427759097, 2185658887, 1163027876, 1011256292, 9249511, 1801471055, 607185034, 2910136394, 1843142226, 2187151057, 392784349, 4018749244, 1697737784, 1946198907, 2183679930, 717192117, 979710424, 1005345861, 2781750481, 2956008192, 2969105983, 2651531188, 1327203827, 422966488, 395453349, 4120541482, 2126568526, 2870308692, 1905241460, 1780882275, 2641054, 2454041072, 1583097502, 4144745871, 2739979904, 3731086783, 2754941132, 1077991004, 2444731016, 1897043833, 2670225031, 2173045424, 1823610417, 3178993478, 2690622855], 
        s1: [3962496606, 2552508630, 222515264, 3582403971, 2804457519, 1186238500, 4040644044, 2351916121, 2601971773, 1422432953, 545345040, 2642555427, 125911197, 2735802214, 1641227958, 363712385, 1762793487, 4144937169, 412693513, 2733978362, 313337882, 961978804, 2057209547, 3657364676, 3861782356, 4076739492, 1341013742, 1619923638, 1539487048, 4202189690, 2496971851, 1017918000, 3318146804, 228361174, 2591886594, 938741573, 1086271298, 84318165, 3719105768, 2552427558, 3563830623, 1274469928, 2830176264, 2891671865, 897496629, 3671845848, 2651226378, 232847642, 3843909712, 1405711374, 4026171531, 619634912, 1142171363, 2238988845, 395367975, 454862749, 1456034678, 819618581, 1324668599, 1224521749, 2786259809, 143010138, 4166378310, 1598368753, 1728176732, 80719579, 3840322580, 2553734025, 241224664, 201798936, 3804694561, 2574506555, 3913916379, 1116035469, 783558355, 1652623649, 155340220, 303346435, 1109758292, 3310855117, 3591172608, 3874994581, 3499868595, 2661429902, 2049953651, 3315376208, 3736451197, 481754802, 1167769850, 1181710638, 415151967, 3989237540, 1243799551, 3157915884, 1480514344, 1692094754, 2250382894, 3335586101, 4120813474, 2477760579, 249695838, 33785352, 899032694, 1172217604, 3588974131, 1259558299, 414891780, 2582088500, 2661153594, 404976735, 4018187998, 702904095, 925995571, 2304049896, 3026200956, 394229630, 32577249, 61990858, 283702905, 3948257859, 713855766, 3151292791, 580422252, 3132370473, 2342554365, 3730351923, 4209807019, 3772071699, 3293959668, 3662323641, 3802976970, 2816777175, 1139474211, 4003171461, 1956907662, 4254884147, 4294133976, 1705679575, 3391177912, 403819195, 3064730920, 1716554991, 1195212409, 1168482116, 3327508741, 3223311286, 3462595387, 2080178200, 279433081, 174440574, 3352350727, 2367659382, 3646371245, 1928581568, 2397960873, 4275169891, 4187077828, 540407125, 1562933564, 1166240133, 1380119816, 2727414763, 1736215523, 4226091473, 849805087, 510719666, 3334611835, 274490044, 3187593504, 369193352, 2223471375, 604305504, 1229729647, 144991784, 3158539392, 2299573150, 3295702799, 655653018, 4045919999, 1788357037, 3608953741, 645102547, 1416351814, 285617880, 3968675319, 1096843476, 2384883511, 1687389758, 3973249456, 3814566887, 3925871421, 2151913806, 2285296547, 1029399185, 328833279, 567878735, 703080618, 4249068939, 1134548749, 2790616170, 2005390767, 219726046, 1464845377, 2366943447, 3010997628, 3809552131, 2764756729, 2713096324, 2147868695, 4243462390, 4058067423, 2648706567, 1337215927, 1815518780, 4051730534, 3101485965, 2827637369, 3117795056, 1481329097, 3808647903, 3161220914, 724729296, 1552304935, 3157865557, 2869349817, 2916215632, 526888490, 3716040013, 353093815, 985012460, 2988822823, 2018999046, 114273730, 424095540, 3626846947, 1813046020, 549911021, 2450120110, 1048851768, 2826456503, 3355549968, 528705553, 1303371162, 2062335363, 1083697445, 1526925516, 3416814274, 3149503049, 3710361025, 376540582, 1427790221, 208982209, 3971476064, 3683554035, 101274604, 526517001], 
        s2: [3685627420, 283257260, 1307490422, 221944528, 1993112682, 2201606544, 3903061989, 1252847488, 1004609235, 890577980, 1102909118, 3889491091, 580323624, 3888668565, 3085850073, 3215509807, 3915987791, 4017985969, 2348265632, 1436524367, 2635969236, 3111264386, 2414551693, 1636703225, 1271300427, 4028508949, 2833621234, 440166776, 3823533275, 125547553, 4098542868, 4023206491, 3474693450, 4098334254, 1512006521, 901832118, 1744676275, 3548227353, 1141595543, 1768025375, 3667342943, 1089967361, 794530069, 386216310, 30479815, 974474400, 699512230, 2756811907, 2721179959, 257710782, 3713828105, 1437079773, 297372929, 4111060683, 382050131, 303181113, 3754106993, 1604691903, 1394522882, 3508891855, 1536966561, 3280943270, 4226578717, 2393064390, 1792763813, 2101442859, 89352651, 1071713142, 1150564725, 1830934130, 4014117514, 1521720041, 1602593328, 231472306, 204085419, 1137504026, 3033804805, 3028201059, 24425569, 796322949, 3954049391, 1593439311, 1013190970, 61630914, 43420150, 42024804, 790868153, 1279275373, 2270406383, 1819700563, 226924228, 3721125138, 2693655083, 3223207991, 533840600, 3468326096, 4212966299, 3112480374, 2519843792, 1826222951, 2251058409, 212091378, 1409614329, 2212865350, 406143943, 965398700, 3224077225, 2637045624, 24239588, 588019672, 265324223, 2854979512, 2495238091, 3584118028, 1319283667, 1423349420, 1488220412, 3156007823, 1172950025, 1096432458, 4039031271, 3882368782, 2579874423, 234678667, 173971341, 2790152840, 1130648232, 3848282037, 2006676167, 785328744, 4128898217, 1332904739, 2099250375, 158546208, 119865937, 4174610581, 1010060521, 853243873, 3267818235, 808876710, 1949995479, 1241421430, 2516538691, 3583342729, 2698150010, 4097625964, 3840390700, 3470689394, 2553760595, 2060594845, 2958559175, 2116407437, 312638317, 2310054785, 1385515620, 1378096018, 1027615097, 1445945703, 3108836515, 3103922174, 4011089680, 1964138368, 1005488690, 2453683526, 2175045869, 2829162940, 4189560507, 2433539853, 2272185927, 1877827865, 1187444704, 2436279572, 409376661, 3357284546, 1984658081, 2377658472, 2436455049, 423950495, 1691385143, 3669794118, 637150503, 3647475868, 2927104663, 992086376, 2539687282, 888099503, 1598299211, 1799928638, 1228665421, 2273804068, 1115658275, 2143587859, 1595400394, 3796549812, 1783913498, 1492572840, 2013214876, 107424075, 796714868, 44515025, 269318579, 3952378672, 1474024361, 2438560873, 315299687, 1032114545, 2601134415, 667247245, 2665530964, 1609190326, 3008433471, 2774780060, 1934725931, 3354571878, 1112264762, 3804012390, 1311192607, 3407311175, 2226580228, 4022278187, 1512416562, 2670556501, 3245730218, 2701029024, 3033083350, 2087911248, 2584296289, 4106951518, 3829881038, 3181042549, 1358373811, 1246114361, 2701159509, 1307770910, 3059347414, 2594013556, 158862869, 1001875314, 1233324028, 691505761, 2226616826, 567074033, 964276726, 1692433609, 832219072, 4231138557, 1273438392, 3479079679, 2798056815, 3260250354, 3782917383, 2013046838, 1827450148, 172008005, 883567517, 1589237711], 
        s3: [84759111, 3262702768, 3415301105, 3498683982, 1806500368, 1425319193, 1472304172, 74674307, 1230400825, 4189778135, 3704989578, 2787466472, 2954396438, 527602333, 2840318508, 925495642, 768531679, 1202717585, 4256924484, 4126776357, 774327013, 2474928946, 2934716214, 4076028696, 1185929969, 520385101, 2331066174, 3702855488, 3157194994, 1400026809, 3183103004, 3997395841, 725527464, 3521588893, 2635112993, 3866446662, 2968353960, 607037316, 40648425, 891050943, 1604951499, 1996687073, 2080634266, 3480439703, 763831655, 2817425755, 3841065428, 727834143, 1275857414, 3594921046, 2142990827, 3099540514, 3415965085, 1501032123, 2122609375, 348413122, 196445717, 1637427467, 3911606188, 3694337409, 864261711, 2186312749, 1094067124, 1632845555, 4098705097, 2339412576, 2494400846, 833770154, 3158578307, 4010859890, 3484444264, 3143409848, 983905658, 3437176874, 3121812841, 272773918, 3123927979, 2586357552, 574019862, 1772662464, 3823827764, 2409179452, 2068095815, 1612005033, 503394576, 2528526117, 815443612, 1028822502, 487240786, 3200847844, 843928357, 3189859270, 4107138296, 3049907173, 1547833601, 3231861593, 364655566, 2111371701, 3326771650, 1830332040, 2850190400, 2159194433, 808038895, 68148975, 478673726, 211800080, 1345056815, 2187115125, 3302249696, 806234965, 779445231, 1652239876, 890666980, 4082298281, 1939725165, 1330146288, 3238984746, 2732596984, 2916723342, 1672631159, 853901782, 2861934109, 1289855665, 82648941, 2783383209, 1573548653, 1395766733, 405142433, 572041807, 1055612848, 1419013391, 2883620447, 1598711710, 300381041, 568188790, 3104900997, 1613816486, 2825850837, 4225388613, 3357113916, 8878598, 2454027904, 2566317048, 216550415, 745967593, 3556290733, 2107695390, 1609749594, 1924784573, 3178039535, 3734642787, 2893496208, 1242032474, 2595434836, 2547521915, 3254258156, 543931237, 3784217054, 2357593656, 2413447429, 2753581456, 3262687437, 1009751023, 555563296, 1058470773, 2836915311, 2502951802, 2633724524, 2581214084, 2953676085, 2718688451, 3893942462, 2573746868, 1813121025, 180187643, 1331709241, 2061273165, 1140298244, 1103804087, 1207650037, 4094055730, 921021473, 2411241099, 4279844584, 1263293648, 1581212750, 3723662096, 2222721793, 3098716864, 3003265979, 2093061828, 3487419568, 3996574218, 396020977, 3039732243, 2261665091, 690914946, 3714429948, 99761742, 233717755, 783564800, 1560685380, 2235163239, 2378935054, 2693616688, 3780077013, 1566412032, 1264476395, 2712542660, 670519187, 1471879859, 885825868, 422834064, 2012549931, 2480300966, 1527437015, 1895856530, 1186445316, 2453357391, 1178414621, 2985326555, 2432579646, 1771120441, 3798818790, 2156987799, 3215223273, 722733568, 1055923389, 1027237683, 1849935838, 2161268991, 2381563183, 2253659048, 2532778422, 1366542490, 1556257565, 1947849506, 3328946959, 3737936767, 3428936422, 2406820394, 1017652977, 3207940882, 2191896800, 3248390212, 3332163952, 4088114401, 585938406, 3458677131, 1885106684, 2078372879, 1828742801, 4003157356, 3845316270, 1522199472, 2596050418], 
    };

    assert_eq!(state, expect);

    // second test

    // InitialState
    let mut state = State {
        p: [4198792711, 3221820076, 2445127235, 3478252886, 1377376860, 3974342687, 2171347387, 198217523, 2945479072, 1553666651, 3944994377, 3462227495, 3802714748, 2752090413, 3065262296, 2565407784, 1884268453, 4173154018], 
        s0: [2442004048, 625185919, 1759208898, 2116658210, 961894564, 426970035, 3426453748, 264593353, 781028048, 2772235394, 4107314173, 1015074636, 4032633005, 347926529, 2093764090, 1472387190, 3028232063, 4158870177, 3401573232, 2807335439, 879492209, 3893475457, 3166848721, 2411707114, 3614250447, 1558389244, 3754551199, 2075141746, 412805773, 1657306880, 4262505340, 1154268965, 4149786907, 2170941741, 936791149, 3907500611, 3477578235, 3993645419, 3515446632, 2248164169, 840555946, 2771745523, 1863280138, 3928699937, 3533293685, 660975411, 1027413559, 1430653865, 3637815700, 483648847, 4218359548, 882267343, 859208873, 652617507, 3777306800, 3995646063, 3754184757, 2428615391, 1631428070, 2912420800, 2093854638, 102000018, 285302035, 3979800908, 3609032697, 1871033438, 3753340840, 1320556139, 4170319587, 3437905526, 4036654153, 2074879030, 2706247837, 1038594662, 3725307755, 1037397115, 3856539558, 1539615971, 2684399220, 2145040473, 340495441, 1413810662, 2397029632, 4074109096, 3869726868, 2556444421, 1906590730, 4012759021, 4239943011, 1914955213, 3247363387, 2676658041, 3063216506, 157471218, 3134440337, 2892385185, 2766623069, 2776670339, 3980581635, 124851476, 889531642, 3147427692, 716512613, 3915614905, 2605072737, 152790877, 3966056099, 384690076, 3688209460, 2396052171, 356868816, 1751902042, 3150456140, 3932955916, 3431303151, 2000461623, 2778726344, 3305253337, 3418686618, 4147423365, 2457172338, 34210018, 1624243847, 3358037252, 2436939873, 1164170569, 1172832825, 2264163552, 1301063673, 721096128, 4111652644, 1709983433, 2035366040, 476902631, 3758586299, 1195527285, 3959609230, 1978496322, 1945391959, 2655414367, 3880529410, 3941130514, 2701834474, 2035338292, 923242308, 3078019016, 897224040, 2295361136, 1062399590, 167510951, 4282334458, 3580934393, 3677216500, 2894203177, 3514294524, 4240491114, 2301987184, 3687898082, 1091398329, 2359061240, 4104911627, 3817329422, 1613019019, 4011202283, 1969223139, 205171823, 3814625821, 3663306214, 2556306345, 2560504809, 1561033981, 3787744812, 4049565195, 3092277867, 2596075916, 1090626408, 3779277025, 409136645, 2049289721, 229505685, 2668070742, 435439445, 1244117060, 3414528119, 2581316975, 3541970912, 885267068, 3782718164, 902673216, 1870124706, 4058440864, 2667060664, 2832796074, 454250181, 1268026837, 2132894412, 1774058731, 946933329, 4232957753, 2324485273, 3434265643, 1908041089, 2947378890, 4101002767, 3956043995, 4202393118, 2819099669, 562538011, 1944619729, 295946998, 1733610380, 1610339847, 2897267963, 3981170790, 2576428007, 581472594, 2429329931, 4043888031, 1542095305, 4260712686, 3139297214, 325655816, 528835219, 2223421659, 3445697808, 3894317549, 2443780771, 1253688842, 3732621141, 3416616152, 2690261098, 4143785928, 3527170367, 840889210, 3689609128, 4234102284, 3212102387, 444434476, 3081133844, 2292406873, 1929249614, 3929349857, 658666621, 4294188416, 4134948799, 3236307124, 2476268542, 2021937894, 3190283033, 317563632, 1429777180, 3497349672, 3786465419, 771450499, 1539162981, 475826536], 
        s1: [1191582771, 304231506, 2295009182, 1431552268, 3995423223, 1238834765, 2291277056, 3661135308, 2639670979, 3734134782, 3000599838, 98010453, 86501682, 2508928237, 1419291509, 989309578, 1587788407, 811492728, 2288012033, 3434355358, 675890780, 2557135489, 1370657226, 928721026, 2818138642, 3609000504, 1233512028, 2967216955, 2543495254, 1358783447, 2679888589, 3324424376, 3775404721, 494521412, 3926237795, 2528093334, 2271767748, 2658268219, 161820981, 4102774669, 2458944569, 3215953302, 195299014, 4178574500, 3080698947, 1508681163, 1930748133, 360143240, 614490866, 2063089316, 3449490707, 3325772139, 1495721318, 909744907, 1937067460, 1546512090, 1395519384, 2556068340, 887808371, 2352369059, 3647470168, 1460038665, 1928062625, 3395607185, 187267777, 3712822001, 2686696336, 3932991244, 2516775518, 3255739699, 1036450159, 2308474702, 2138873966, 3386242577, 4117687539, 2752432777, 1487169500, 3929172738, 4203410257, 3547216485, 481975617, 3269398489, 3636977434, 2208568319, 2507645378, 2495661196, 975434946, 1581194203, 3547252040, 1296718012, 2151124522, 2475706781, 1853748, 3154392943, 3452193681, 2468482869, 2227615244, 1844009567, 667062253, 1166666948, 2975334198, 821188883, 3687660734, 2821430884, 1890798971, 1823730758, 2940761567, 220876745, 2629243488, 734608673, 2536053406, 301373968, 289849331, 1639017159, 1213308908, 3310997347, 3175528947, 3351378611, 4262744129, 4270231059, 740349280, 3619118826, 2539592904, 1385842372, 927756852, 870934327, 154575757, 1741439408, 3591430250, 1063954231, 590048262, 3885644575, 2825022727, 1752638384, 3806043523, 1798894500, 662752305, 2507126370, 492946572, 1405452395, 3809258896, 3952797292, 2739523612, 2308070475, 85226850, 205207061, 360497109, 468121479, 83041395, 3728049902, 1055402796, 1373254865, 3031818113, 781458345, 1644306995, 406965631, 2123374440, 3385087564, 123099451, 474430965, 207394447, 2248671171, 3177048129, 1112094761, 28090440, 3155572900, 3726523330, 1190738929, 2859478356, 742501817, 2999722530, 943340132, 2044305226, 3511239144, 2868341689, 2903022313, 3725023927, 1670924780, 3450916414, 845147120, 2130945826, 1661760984, 762653304, 2896751299, 3357582119, 3223922640, 1226381115, 704513318, 233090824, 2354629435, 4176037045, 1361817858, 81623346, 3289087942, 1342082944, 4071655792, 1843286507, 1872393514, 583698842, 885027597, 3402411094, 715091016, 1319507009, 1228390415, 2006109436, 2109897626, 776298119, 1093084991, 2298406617, 726963637, 3665279050, 3570963187, 903174292, 3898144725, 721434032, 1977841814, 210519324, 1492731447, 4054889092, 3281814876, 1107314989, 1081063653, 2265196638, 3337408859, 883982581, 1695039955, 3871736158, 2076500002, 2216176522, 1984811952, 47897494, 2268553027, 1388037937, 3262041339, 2003384845, 1999852012, 1563040632, 310999044, 2296881711, 3360426256, 3249217113, 3857585173, 578437315, 1678366297, 4128355515, 913986309, 175579517, 3646598239, 4108972447, 1645477473, 2469947841, 221325781, 1619948274, 88351649, 4204364748, 3416526293], 
        s2: [2529644861, 3148119050, 3630134853, 3846529833, 1081404950, 957969752, 237357407, 35194461, 1005437086, 2867999212, 3885638407, 2119944269, 3125135616, 2154858691, 2947323594, 2571683497, 1066294886, 2135422832, 3047769540, 415841169, 3942420441, 107564082, 403831543, 470431209, 2878287321, 4077707352, 3397982821, 2105130412, 2973536828, 2602432224, 2293705152, 523258372, 2042404312, 90395162, 997382184, 260985894, 4013722219, 2274364493, 150288564, 4176852302, 2174583765, 200006060, 2436767793, 1751432885, 3276675600, 990023078, 563654018, 2781205936, 1627714984, 3428787098, 2447694403, 3289140807, 2859156759, 3135314825, 3271441977, 1847055451, 282099993, 655045690, 2428706855, 2033828868, 2281137179, 135793684, 4188909235, 3135667579, 3419132073, 4563143, 1696331402, 743975374, 1169113908, 181056871, 2711654948, 3567367477, 3309506319, 18017907, 2373779051, 114540494, 531196015, 3690179717, 835850523, 1034820273, 3147689555, 1113075358, 484306663, 3373754305, 815729535, 1016514685, 3908282895, 1912673545, 1505044381, 1927506532, 1363340266, 1524625148, 976301777, 2024805907, 781251880, 2606076462, 3619733971, 1316284069, 2299263450, 3703321634, 2643595198, 3809261884, 467464190, 3072099886, 1407489401, 2281497098, 518790152, 3511996689, 2840815891, 853690763, 476612184, 1878253908, 1360692432, 3835189487, 2401776802, 1743396752, 3920529742, 172272429, 1618285522, 3393245730, 3033987311, 3920872438, 939046042, 517157673, 2052624646, 3219655876, 1404279370, 4289290106, 2103824553, 1358224676, 1332229221, 2787212684, 650403635, 1069782632, 781661451, 1591964681, 3366923314, 2628543698, 123234114, 2309796811, 717864594, 1968737629, 2774795525, 2179615359, 43022332, 885246260, 4128815415, 160411978, 1413629827, 3974655282, 1681617417, 2377184172, 2655430155, 426210499, 815270095, 1382985107, 1989222996, 575128320, 2471889392, 3042835367, 2785908213, 1682992814, 4258900379, 2608223046, 44480877, 3562064684, 1048588527, 2478062929, 683786405, 407097349, 3432583758, 1186717714, 393296750, 216709849, 3274815831, 4222341140, 649173402, 2073437596, 1154201470, 3146374119, 2305977070, 3917383645, 2254952722, 514001449, 3376762940, 1878491269, 1321205176, 3786054843, 1519655089, 10124990, 2783573985, 1894869075, 3021890158, 3679697753, 2536853901, 2000572719, 2232463986, 2418407442, 1295954705, 3662653177, 3796513712, 3927225858, 2785989892, 1168068646, 676184117, 2020823486, 73308050, 4220933603, 2508113152, 408697634, 1120970140, 3644739873, 4016635265, 1784641304, 2230876133, 1453688, 167511997, 1358667693, 725050089, 2471442918, 735913212, 945037947, 2129168807, 1065491038, 200647370, 2477859576, 679659188, 2282444350, 3415892467, 3092129218, 2451605633, 4148849081, 3237696285, 3867947314, 457963525, 3443580126, 4260467036, 2145894403, 1736113656, 672069558, 4259789263, 1081501330, 3587559089, 515037273, 483503941, 913006054, 538782646, 483373163, 1902484688, 2917272699, 3219603054, 2933070194, 3859258283, 1296397642, 1814099045, 1673597746], 
        s3: [3102059429, 856853060, 352097831, 3548145117, 2027595304, 2936651428, 2705964536, 2653708995, 484328797, 2028825581, 3840041667, 3371872765, 435939022, 3372906634, 3424478700, 2031722322, 1271480985, 3616820150, 893989451, 1338328776, 1154228023, 3977486549, 958445542, 29847001, 1071801319, 2475862945, 1714168159, 2374122849, 432434059, 760200690, 3976100264, 3592501813, 1520581470, 3109522869, 2922739454, 643142669, 1720217985, 3538263808, 578455775, 2675420510, 2665364143, 1181452985, 1267924265, 1303494170, 2321458648, 2284787796, 4188775301, 396172835, 1766031958, 358620770, 2945698685, 3676195748, 3714932691, 533858085, 460601242, 4046602362, 2368068326, 1070541782, 1662256374, 3054231920, 990153039, 592240703, 4060557425, 3001380352, 3921004299, 2374455298, 1095174907, 2760922482, 2047101691, 2251652655, 555050524, 2324821334, 4171170767, 1874898150, 2870765004, 292699967, 3028039941, 244952613, 2106126734, 636240036, 1567116773, 2531676058, 1381770811, 2819499560, 422464044, 1976898120, 3688895558, 3200576988, 2469575890, 3670053367, 1380188101, 722202228, 3674638304, 3801397053, 1061030650, 832512100, 136869077, 35596769, 1075605404, 227785938, 544809896, 1176576376, 367938615, 1777112625, 1541960813, 1621892160, 613893275, 2640193228, 252391926, 2452604861, 432326937, 1377658807, 1319542658, 1829359563, 278008528, 1480432282, 3130134945, 631028227, 4257241390, 4128271807, 2581868322, 926617857, 952899408, 2114542376, 3716150828, 2454388794, 2611305607, 2687734678, 3846592006, 3669214303, 2742364302, 1707732049, 4059851558, 192054578, 1409240038, 2041216016, 1846004629, 1601907662, 4138965961, 2377163262, 826283680, 1384577784, 3294713786, 795551324, 580078061, 1003838151, 2834713820, 3250292129, 915049676, 1400088960, 2159397766, 3806448328, 2139956105, 1402632623, 2833484679, 1662951826, 4128952357, 2169490272, 748998986, 1021709257, 1156566110, 3081432793, 1213709073, 2211964991, 3636868554, 4045692912, 3787143573, 2494584817, 2811496988, 595463657, 745476853, 1883574820, 4197749065, 530381538, 1370645049, 3877829679, 1343836008, 639997097, 750611545, 3326727274, 3008293369, 60118546, 3639957660, 1850832221, 3187304243, 1958376857, 1842453718, 563403412, 3080824289, 3630025675, 1905400176, 2883180385, 2486702325, 876947604, 2911275999, 3718854592, 221354128, 2448227573, 1147511698, 3791173686, 3168199612, 2748832359, 2819417425, 2981556426, 4149499, 121269032, 3656390876, 2033665995, 1872355436, 454024782, 1323116870, 3109392582, 2111339175, 1645573813, 4020774450, 2769202483, 3865877956, 1361765295, 1185926366, 2000197624, 2163331944, 851202299, 1671950857, 3628139618, 3266151709, 1135403481, 1460928896, 1947370551, 4112921677, 3095282309, 3497195290, 3863033865, 577036024, 185834947, 2318188981, 69475481, 495816981, 2096732769, 3543579402, 3746686615, 171702325, 1734089486, 2970057240, 1397916004, 2660721696, 2793732166, 2604790929, 3374077273, 2345328795, 884193187, 3447459906, 1001292491, 1150901005, 1332987298, 1968849211, 3571743265], 
    };

    let key: [u8; 9] = [112, 97, 115, 115, 119, 111, 114, 100, 0];
    
    expand_key_without_salt(&mut state, &key);

    let expect = State {
        p: [2798345663, 3115745837, 2763382015, 1749406558, 976822291, 523064496, 3184405352, 907279524, 558847559, 126704181, 1995809897, 2345914700, 1472880934, 2841018953, 2847203361, 3185113695, 1142202220, 2630248292], 
        s0: [676454462, 1272271786, 873539675, 2686839465, 346506097, 80399275, 589438928, 3546369867, 1744143904, 798926874, 1391086939, 682941477, 1578622682, 401097679, 2024993445, 1417445980, 4177508923, 890062054, 1064000466, 1647720969, 1490177189, 1167966610, 2264910206, 2923843517, 215363410, 2282976449, 3801510020, 1564045162, 3629947254, 3727846370, 2556094668, 2505563232, 2855160700, 3770533416, 3427686803, 4016995316, 512427023, 3911203205, 2520226884, 1362267430, 1381137896, 4042378721, 2541622922, 1244669430, 599905514, 1624484630, 4072573318, 1138704991, 2339750700, 2162812977, 395230942, 2230326491, 2465044422, 3784799856, 1750276821, 2295856874, 3426829462, 3720468502, 2135801387, 2887582192, 3109909476, 2456150104, 3845483894, 1422107140, 595793670, 847786699, 2605084776, 856482520, 673871047, 3405181999, 3772409383, 590060505, 3462290958, 872190849, 1202270770, 3247173893, 1157753935, 1621706027, 876563378, 3052551887, 3582498882, 2197894774, 2265681996, 2936446246, 212240664, 1150253480, 2706019237, 416678421, 2865927298, 1619962987, 3453808263, 3394098819, 2181706984, 161189268, 1087269757, 1408120018, 3555862541, 3890496653, 1622583788, 1201082517, 13325912, 2481323395, 2886997398, 582438366, 10752657, 897241492, 213153084, 1339012003, 2069764703, 193873211, 3148224487, 4148882944, 4062906972, 1245900973, 3977317393, 516503615, 2240484896, 3877270803, 3944895778, 2457151727, 1961223094, 1719245248, 985802346, 3757149277, 158778694, 1747466634, 2538774909, 4168471760, 1009630408, 2020491438, 2342975169, 946066840, 2450061377, 1699508125, 1676930974, 4066196740, 4027983924, 2089520038, 1959644623, 2794884420, 1507899473, 3020273735, 1188587956, 1995449644, 2296724221, 468242640, 545940833, 755575733, 880500553, 2220431864, 1539270408, 3630768707, 3795475511, 4209806151, 1323022845, 320768024, 1807049611, 980508812, 3531533438, 3165506942, 2340160596, 797871149, 1328658604, 1462603394, 3400811938, 671157969, 3238724695, 3803045339, 4173818433, 4039602328, 4028597456, 2394262622, 4109411345, 3230436700, 2761214522, 2041596342, 3713248210, 3064615133, 1966874445, 1633610046, 3310483970, 3305576161, 3575359423, 3568886912, 1009790447, 1642127506, 2457607754, 2532309753, 1155636415, 1536221689, 4238025853, 2499952280, 1990575775, 3242602078, 2733057994, 3402500736, 4248247392, 3100143292, 2419329322, 1561780075, 656363637, 2059510138, 3767462873, 1109331618, 3838620982, 799019198, 1106642236, 210589368, 2641788265, 3850512603, 3423250279, 3750610059, 3402867847, 2058330547, 2000711402, 1301080353, 392514224, 3375686461, 291108565, 3765240868, 2709332991, 1397411465, 338171739, 824750237, 637342327, 2117562810, 2978388429, 3743659775, 1599543927, 717482022, 370245568, 2584857805, 1833958769, 1850300501, 1198012449, 660140659, 1235446080, 3782618883, 431355351, 2258602910, 3585404750, 3266561928, 254601067, 3951737387, 3828621245, 441640376, 642288526, 1207120745, 1502726064, 2384308763, 4159010288, 2267249720, 1638774133, 2987030575, 162935479, 1200247442], 
        s1: [472083812, 3770068924, 3074822563, 1394638570, 2018825446, 1545052392, 2759523341, 2303311498, 3702742967, 3395724093, 160530801, 3162941321, 108239659, 497607001, 3984001488, 3855678334, 1385193553, 1283570665, 563810886, 2744781965, 2037448858, 4072755815, 1130048568, 1161225846, 3923783090, 2244609586, 2758115005, 972586975, 2994878506, 2335626542, 1222161726, 3575998520, 1811591414, 688489649, 3616227426, 3848634866, 2687180076, 3369171229, 3489648410, 4109761960, 1979793800, 1639610142, 3894504781, 1935786209, 1137045381, 1357340853, 511746915, 2965293695, 4088114496, 274179101, 209783419, 2601040942, 1166602590, 970463802, 55401265, 1957366110, 2441834901, 4243751280, 2828724468, 1057010323, 347987147, 751488028, 2896578520, 1715167967, 1879210500, 3744571943, 1185917501, 3675757271, 3343686823, 956694973, 3886903973, 3377797106, 2357771222, 1201633320, 3111334010, 259874874, 1094725687, 4166366972, 757063657, 1653946250, 63407545, 904858797, 1832511644, 3700840539, 1986739777, 2957115747, 3554612275, 545713679, 2834593402, 1950223834, 512841807, 817078044, 1441861257, 1086178079, 2849597330, 2276442937, 2639342265, 2969233466, 3205632041, 2550514228, 3779069632, 1101862162, 1461055711, 1901975352, 2148999055, 1249638228, 1350882448, 991791964, 1820699849, 3305872710, 79273359, 2977191022, 4088126989, 2566924723, 219721535, 3660703706, 4280578078, 2411372537, 3074400355, 1172161233, 2289293138, 3026389107, 809380459, 4204707391, 528056201, 685214699, 375865914, 245008467, 2578197650, 2887311787, 4174158394, 3969295308, 503822146, 1633335771, 1276824390, 2980955141, 2150986213, 3138745685, 1190295702, 1294220900, 1696759029, 677819787, 2640120040, 3695687532, 3347843687, 196624891, 2012397063, 914232896, 263182696, 4255683727, 1429031079, 1097467998, 424953395, 1065731215, 43704444, 1400758775, 3139714064, 2700405497, 1575344090, 1311475223, 3310906608, 3426033111, 1837813496, 1100828187, 3761789251, 1042029661, 3014880156, 1039817220, 1426312212, 3124688189, 519510957, 4102485857, 1750901621, 3292710582, 4023532517, 690834380, 2025093781, 3675008004, 3912948477, 3363849698, 230551464, 3259085937, 2799086180, 2752228053, 3465947293, 3528386667, 1271741700, 553212838, 1717392035, 281395822, 2430583899, 1872973280, 118285136, 1717347996, 3281069787, 233679973, 1699453913, 3437232145, 686047307, 1863873988, 1012733795, 3277841047, 1309962133, 3392045945, 3271264563, 3160473246, 2210226009, 3614952385, 3302658752, 2433634201, 3655259080, 437840847, 3153048205, 1583554996, 1568000745, 3975017185, 3346426236, 2565139829, 1837068378, 3063369513, 1571453132, 2064559192, 1085836357, 3267641108, 3845033331, 1201488240, 201428592, 2479505812, 1945014716, 3231625898, 532586551, 193379039, 2835709134, 1293194257, 3342170242, 1139754580, 3897799688, 1685600441, 1250982870, 1808707925, 3855802002, 2950876679, 468455925, 3756271425, 1737879444, 63597990, 368933745, 2065537199, 3980218754, 3805214281, 272723093, 2150910972, 871152404, 158127437, 1690237187, 927392735], 
        s2: [2030326932, 2507010455, 26158438, 3725388351, 2827182470, 4003922793, 834815126, 625710034, 3685449788, 4100294130, 1803019407, 4200828846, 4019237533, 1065582197, 1008134547, 1277516665, 3248993370, 4091513230, 2254758447, 889650927, 3857002503, 1810437854, 2693574866, 2153178087, 2526675297, 292778563, 2414198035, 2134368959, 3087955945, 2069083953, 3965701497, 1206199560, 3146429849, 968450073, 2069776255, 1911534690, 909933859, 2304242151, 1065811415, 1335555609, 3341927736, 3948476544, 4244228698, 270363479, 2783221329, 4216729437, 217572709, 4151157255, 698017677, 3246721908, 384431049, 4130797755, 1690322415, 897481564, 1587130138, 2558439988, 3504544659, 3187557190, 3128660588, 797093593, 4089651264, 2438984586, 1202012945, 3856974218, 298101502, 4196327919, 3053067125, 4149446696, 4150214910, 525539971, 2862528890, 4139338054, 3383699189, 2516470702, 2342477462, 1930074435, 2458317393, 4294173046, 2232132528, 3163216971, 1148393569, 1533976930, 2461998106, 3187382800, 2908101331, 2173866850, 2716034867, 3315171691, 2226484691, 1129677529, 3032691043, 3747691609, 382317315, 2415638257, 1069529056, 2599207624, 1601615811, 2462391962, 545160938, 2060161592, 2065802002, 2005979921, 197889807, 2349970015, 4137964465, 3209705719, 2547085506, 3215155239, 4203071631, 23539487, 785833022, 608716249, 323605815, 3470461295, 582077769, 2014866809, 3276389219, 2542666213, 2954548574, 1208429978, 695367851, 3861383595, 4119580400, 853482003, 1937150713, 3017236889, 1256531801, 476432355, 171553789, 3666343247, 1093329128, 3155591722, 1836731114, 587515344, 1296896133, 2940519146, 2241994447, 659122235, 115224071, 336870305, 2278874910, 1003897532, 2961589262, 563227713, 1506881705, 59364574, 3185138194, 948354866, 2604640349, 1889095203, 3875814229, 1555249954, 385718770, 2473809579, 3473451448, 775784206, 1339279198, 3118846800, 4187284313, 2139224444, 3579127849, 1759057686, 1027665254, 3550009772, 1748616252, 4094256760, 1705159032, 929888260, 650181553, 1305356803, 3075799978, 3069245053, 397890611, 1182603630, 583738411, 1516215248, 176785336, 3801891317, 1825933230, 3513410704, 3659920259, 2033876061, 3185876042, 2547054828, 3838441518, 2053794257, 3582741925, 2768950096, 821526076, 1709927365, 768450230, 2092381618, 1976840479, 4041788251, 1454737280, 1891915899, 1423376867, 253761025, 2454386056, 291500795, 4213297989, 1548710689, 1503794241, 2050726474, 3978427262, 3692476685, 2756987704, 1221368249, 773460215, 1337618276, 3867562030, 3882723728, 4131048417, 485412475, 934897990, 3707735453, 3639623222, 3931679494, 3938395040, 4290140595, 3737516535, 1247404677, 3311241978, 2182947631, 1098880326, 645797237, 4191674413, 4097321855, 2732354876, 3941919033, 2931130202, 942824492, 1769446651, 2192528067, 893852461, 3808612987, 4037091546, 501924547, 2086518919, 1225876766, 4240082102, 2988552152, 3546910021, 1673855783, 2508076715, 2739637838, 3971817978, 1029745465, 3518641506, 4096350064, 787534034, 1732927643, 1853386857, 3297877548, 707223568, 4252216022], 
        s3: [3066661050, 616624353, 3714240339, 2123856950, 3647589697, 2065091598, 3916682196, 1117923124, 204986545, 3772252588, 1683898358, 303044025, 587684464, 1042315361, 1228195799, 878423328, 3394392353, 3690724543, 4290544724, 3791164033, 1256286035, 2379735913, 1928550058, 2701921634, 4240462192, 1146079557, 2846198727, 348020271, 3635687465, 2540981783, 409071058, 939175611, 1612444618, 535072600, 4149748582, 2297417044, 4087944708, 964923342, 712583697, 2571436424, 417254762, 2145460236, 2914748355, 1635323191, 3752683464, 3588426158, 1092004328, 2807104745, 2050327913, 1731863032, 1005587188, 3614235807, 4249202537, 308310017, 791496523, 1816478894, 2459740329, 2213651052, 362992044, 398325613, 3964562366, 2098184129, 1782438174, 3167040350, 1348491680, 1920345890, 1768033492, 2841696288, 2664173426, 3792318204, 594520090, 4082840818, 2588617739, 4206593349, 109216885, 3929832197, 2367599721, 1011173935, 2869241790, 3115713945, 3040285683, 2312346021, 63517398, 472670920, 816663545, 1434975673, 1432719557, 2403982718, 912511206, 1688934500, 630376069, 1449091312, 1111886186, 153355290, 2763348214, 988124280, 3787827508, 3221168641, 2167312778, 133348070, 4148354988, 3041645215, 984362080, 464899793, 2763767977, 2695568023, 325049632, 1384378150, 3826507421, 3618639460, 4164111275, 2141832091, 3965800451, 2910159612, 4124981534, 812537540, 3909662663, 4116672622, 182676213, 3287478828, 3787621702, 330417357, 1970377712, 69979522, 2802445684, 1731524165, 3342386089, 649219836, 1191381588, 370953469, 1900215824, 3269090184, 3414087909, 1539404925, 667055825, 2651756559, 3483045960, 699250037, 4140048949, 2903011680, 1273453137, 2268744142, 1879434333, 2415032771, 1658649626, 2184411515, 4196565192, 2919973049, 2385396446, 3843219659, 3190409174, 2524833398, 2469946839, 1072560449, 1247479917, 313762972, 1431894384, 2688661138, 2936734737, 2545127803, 1935150612, 576607727, 3440356694, 3473529451, 28603187, 1625577492, 197530943, 2263048709, 1964272476, 3951756983, 4240229901, 1225608669, 443063074, 3234264370, 2412682271, 89866350, 2410002888, 786106098, 1555281734, 2043145870, 1344858128, 832945983, 4116832824, 3478609432, 568797872, 642337479, 545505301, 3324300504, 2718404481, 2864851459, 533053047, 4251752963, 3922453058, 2952815718, 3684001648, 732886525, 2713385656, 4294817441, 859974804, 41613898, 3142141051, 391438393, 33207016, 2441505303, 3972312780, 2099509232, 2060782456, 3843747884, 1012529053, 454711185, 3706767884, 2717301540, 1611874958, 677450684, 3551945381, 3335043585, 1445510024, 55025254, 2612843815, 2018984302, 1982199960, 1344358604, 818293842, 199452997, 1418842826, 372010568, 1324655810, 3566108610, 2174581593, 2355572514, 1719951393, 1694109702, 44666143, 1035251619, 2439580380, 3491386156, 4024180401, 3027851172, 3374794167, 1396685722, 1095727557, 88817600, 1643725439, 380382781, 1993820899, 1159368263, 2253971990, 3272533893, 3993679260, 1008667172, 3149491687, 597395917, 717383847, 3142131801, 644903399, 1725658750], 
    };

    assert_eq!(state, expect);
}

#[test]
fn test_expand_key(){
    let key: [u8; 9] =  [112, 97, 115, 115, 119, 111, 114, 100, 0];
    let salt: [u8; 16] =  [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15];

    // InitialState
    let mut state = State {
        p: [608135816, 2242054355, 320440878, 57701188, 2752067618, 698298832, 137296536, 3964562569, 1160258022, 953160567, 3193202383, 887688300, 3232508343, 3380367581, 1065670069, 3041331479, 2450970073, 2306472731], 
        s0: [3509652390, 2564797868, 805139163, 3491422135, 3101798381, 1780907670, 3128725573, 4046225305, 614570311, 3012652279, 134345442, 2240740374, 1667834072, 1901547113, 2757295779, 4103290238, 227898511, 1921955416, 1904987480, 2182433518, 2069144605, 3260701109, 2620446009, 720527379, 3318853667, 677414384, 3393288472, 3101374703, 2390351024, 1614419982, 1822297739, 2954791486, 3608508353, 3174124327, 2024746970, 1432378464, 3864339955, 2857741204, 1464375394, 1676153920, 1439316330, 715854006, 3033291828, 289532110, 2706671279, 2087905683, 3018724369, 1668267050, 732546397, 1947742710, 3462151702, 2609353502, 2950085171, 1814351708, 2050118529, 680887927, 999245976, 1800124847, 3300911131, 1713906067, 1641548236, 4213287313, 1216130144, 1575780402, 4018429277, 3917837745, 3693486850, 3949271944, 596196993, 3549867205, 258830323, 2213823033, 772490370, 2760122372, 1774776394, 2652871518, 566650946, 4142492826, 1728879713, 2882767088, 1783734482, 3629395816, 2517608232, 2874225571, 1861159788, 326777828, 3124490320, 2130389656, 2716951837, 967770486, 1724537150, 2185432712, 2364442137, 1164943284, 2105845187, 998989502, 3765401048, 2244026483, 1075463327, 1455516326, 1322494562, 910128902, 469688178, 1117454909, 936433444, 3490320968, 3675253459, 1240580251, 122909385, 2157517691, 634681816, 4142456567, 3825094682, 3061402683, 2540495037, 79693498, 3249098678, 1084186820, 1583128258, 426386531, 1761308591, 1047286709, 322548459, 995290223, 1845252383, 2603652396, 3431023940, 2942221577, 3202600964, 3727903485, 1712269319, 422464435, 3234572375, 1170764815, 3523960633, 3117677531, 1434042557, 442511882, 3600875718, 1076654713, 1738483198, 4213154764, 2393238008, 3677496056, 1014306527, 4251020053, 793779912, 2902807211, 842905082, 4246964064, 1395751752, 1040244610, 2656851899, 3396308128, 445077038, 3742853595, 3577915638, 679411651, 2892444358, 2354009459, 1767581616, 3150600392, 3791627101, 3102740896, 284835224, 4246832056, 1258075500, 768725851, 2589189241, 3069724005, 3532540348, 1274779536, 3789419226, 2764799539, 1660621633, 3471099624, 4011903706, 913787905, 3497959166, 737222580, 2514213453, 2928710040, 3937242737, 1804850592, 3499020752, 2949064160, 2386320175, 2390070455, 2415321851, 4061277028, 2290661394, 2416832540, 1336762016, 1754252060, 3520065937, 3014181293, 791618072, 3188594551, 3933548030, 2332172193, 3852520463, 3043980520, 413987798, 3465142937, 3030929376, 4245938359, 2093235073, 3534596313, 375366246, 2157278981, 2479649556, 555357303, 3870105701, 2008414854, 3344188149, 4221384143, 3956125452, 2067696032, 3594591187, 2921233993, 2428461, 544322398, 577241275, 1471733935, 610547355, 4027169054, 1432588573, 1507829418, 2025931657, 3646575487, 545086370, 48609733, 2200306550, 1653985193, 298326376, 1316178497, 3007786442, 2064951626, 458293330, 2589141269, 3591329599, 3164325604, 727753846, 2179363840, 146436021, 1461446943, 4069977195, 705550613, 3059967265, 3887724982, 4281599278, 3313849956, 1404054877, 2845806497, 146425753, 1854211946], 
        s1: [1266315497, 3048417604, 3681880366, 3289982499, 2909710000, 1235738493, 2632868024, 2414719590, 3970600049, 1771706367, 1449415276, 3266420449, 422970021, 1963543593, 2690192192, 3826793022, 1062508698, 1531092325, 1804592342, 2583117782, 2714934279, 4024971509, 1294809318, 4028980673, 1289560198, 2221992742, 1669523910, 35572830, 157838143, 1052438473, 1016535060, 1802137761, 1753167236, 1386275462, 3080475397, 2857371447, 1040679964, 2145300060, 2390574316, 1461121720, 2956646967, 4031777805, 4028374788, 33600511, 2920084762, 1018524850, 629373528, 3691585981, 3515945977, 2091462646, 2486323059, 586499841, 988145025, 935516892, 3367335476, 2599673255, 2839830854, 265290510, 3972581182, 2759138881, 3795373465, 1005194799, 847297441, 406762289, 1314163512, 1332590856, 1866599683, 4127851711, 750260880, 613907577, 1450815602, 3165620655, 3734664991, 3650291728, 3012275730, 3704569646, 1427272223, 778793252, 1343938022, 2676280711, 2052605720, 1946737175, 3164576444, 3914038668, 3967478842, 3682934266, 1661551462, 3294938066, 4011595847, 840292616, 3712170807, 616741398, 312560963, 711312465, 1351876610, 322626781, 1910503582, 271666773, 2175563734, 1594956187, 70604529, 3617834859, 1007753275, 1495573769, 4069517037, 2549218298, 2663038764, 504708206, 2263041392, 3941167025, 2249088522, 1514023603, 1998579484, 1312622330, 694541497, 2582060303, 2151582166, 1382467621, 776784248, 2618340202, 3323268794, 2497899128, 2784771155, 503983604, 4076293799, 907881277, 423175695, 432175456, 1378068232, 4145222326, 3954048622, 3938656102, 3820766613, 2793130115, 2977904593, 26017576, 3274890735, 3194772133, 1700274565, 1756076034, 4006520079, 3677328699, 720338349, 1533947780, 354530856, 688349552, 3973924725, 1637815568, 332179504, 3949051286, 53804574, 2852348879, 3044236432, 1282449977, 3583942155, 3416972820, 4006381244, 1617046695, 2628476075, 3002303598, 1686838959, 431878346, 2686675385, 1700445008, 1080580658, 1009431731, 832498133, 3223435511, 2605976345, 2271191193, 2516031870, 1648197032, 4164389018, 2548247927, 300782431, 375919233, 238389289, 3353747414, 2531188641, 2019080857, 1475708069, 455242339, 2609103871, 448939670, 3451063019, 1395535956, 2413381860, 1841049896, 1491858159, 885456874, 4264095073, 4001119347, 1565136089, 3898914787, 1108368660, 540939232, 1173283510, 2745871338, 3681308437, 4207628240, 3343053890, 4016749493, 1699691293, 1103962373, 3625875870, 2256883143, 3830138730, 1031889488, 3479347698, 1535977030, 4236805024, 3251091107, 2132092099, 1774941330, 1199868427, 1452454533, 157007616, 2904115357, 342012276, 595725824, 1480756522, 206960106, 497939518, 591360097, 863170706, 2375253569, 3596610801, 1814182875, 2094937945, 3421402208, 1082520231, 3463918190, 2785509508, 435703966, 3908032597, 1641649973, 2842273706, 3305899714, 1510255612, 2148256476, 2655287854, 3276092548, 4258621189, 236887753, 3681803219, 274041037, 1734335097, 3815195456, 3317970021, 1899903192, 1026095262, 4050517792, 356393447, 2410691914, 3873677099, 3682840055], 
        s2: [3913112168, 2491498743, 4132185628, 2489919796, 1091903735, 1979897079, 3170134830, 3567386728, 3557303409, 857797738, 1136121015, 1342202287, 507115054, 2535736646, 337727348, 3213592640, 1301675037, 2528481711, 1895095763, 1721773893, 3216771564, 62756741, 2142006736, 835421444, 2531993523, 1442658625, 3659876326, 2882144922, 676362277, 1392781812, 170690266, 3921047035, 1759253602, 3611846912, 1745797284, 664899054, 1329594018, 3901205900, 3045908486, 2062866102, 2865634940, 3543621612, 3464012697, 1080764994, 553557557, 3656615353, 3996768171, 991055499, 499776247, 1265440854, 648242737, 3940784050, 980351604, 3713745714, 1749149687, 3396870395, 4211799374, 3640570775, 1161844396, 3125318951, 1431517754, 545492359, 4268468663, 3499529547, 1437099964, 2702547544, 3433638243, 2581715763, 2787789398, 1060185593, 1593081372, 2418618748, 4260947970, 69676912, 2159744348, 86519011, 2512459080, 3838209314, 1220612927, 3339683548, 133810670, 1090789135, 1078426020, 1569222167, 845107691, 3583754449, 4072456591, 1091646820, 628848692, 1613405280, 3757631651, 526609435, 236106946, 48312990, 2942717905, 3402727701, 1797494240, 859738849, 992217954, 4005476642, 2243076622, 3870952857, 3732016268, 765654824, 3490871365, 2511836413, 1685915746, 3888969200, 1414112111, 2273134842, 3281911079, 4080962846, 172450625, 2569994100, 980381355, 4109958455, 2819808352, 2716589560, 2568741196, 3681446669, 3329971472, 1835478071, 660984891, 3704678404, 4045999559, 3422617507, 3040415634, 1762651403, 1719377915, 3470491036, 2693910283, 3642056355, 3138596744, 1364962596, 2073328063, 1983633131, 926494387, 3423689081, 2150032023, 4096667949, 1749200295, 3328846651, 309677260, 2016342300, 1779581495, 3079819751, 111262694, 1274766160, 443224088, 298511866, 1025883608, 3806446537, 1145181785, 168956806, 3641502830, 3584813610, 1689216846, 3666258015, 3200248200, 1692713982, 2646376535, 4042768518, 1618508792, 1610833997, 3523052358, 4130873264, 2001055236, 3610705100, 2202168115, 4028541809, 2961195399, 1006657119, 2006996926, 3186142756, 1430667929, 3210227297, 1314452623, 4074634658, 4101304120, 2273951170, 1399257539, 3367210612, 3027628629, 1190975929, 2062231137, 2333990788, 2221543033, 2438960610, 1181637006, 548689776, 2362791313, 3372408396, 3104550113, 3145860560, 296247880, 1970579870, 3078560182, 3769228297, 1714227617, 3291629107, 3898220290, 166772364, 1251581989, 493813264, 448347421, 195405023, 2709975567, 677966185, 3703036547, 1463355134, 2715995803, 1338867538, 1343315457, 2802222074, 2684532164, 233230375, 2599980071, 2000651841, 3277868038, 1638401717, 4028070440, 3237316320, 6314154, 819756386, 300326615, 590932579, 1405279636, 3267499572, 3150704214, 2428286686, 3959192993, 3461946742, 1862657033, 1266418056, 963775037, 2089974820, 2263052895, 1917689273, 448879540, 3550394620, 3981727096, 150775221, 3627908307, 1303187396, 508620638, 2975983352, 2726630617, 1817252668, 1876281319, 1457606340, 908771278, 3720792119, 3617206836, 2455994898, 1729034894, 1080033504], 
        s3: [976866871, 3556439503, 2881648439, 1522871579, 1555064734, 1336096578, 3548522304, 2579274686, 3574697629, 3205460757, 3593280638, 3338716283, 3079412587, 564236357, 2993598910, 1781952180, 1464380207, 3163844217, 3332601554, 1699332808, 1393555694, 1183702653, 3581086237, 1288719814, 691649499, 2847557200, 2895455976, 3193889540, 2717570544, 1781354906, 1676643554, 2592534050, 3230253752, 1126444790, 2770207658, 2633158820, 2210423226, 2615765581, 2414155088, 3127139286, 673620729, 2805611233, 1269405062, 4015350505, 3341807571, 4149409754, 1057255273, 2012875353, 2162469141, 2276492801, 2601117357, 993977747, 3918593370, 2654263191, 753973209, 36408145, 2530585658, 25011837, 3520020182, 2088578344, 530523599, 2918365339, 1524020338, 1518925132, 3760827505, 3759777254, 1202760957, 3985898139, 3906192525, 674977740, 4174734889, 2031300136, 2019492241, 3983892565, 4153806404, 3822280332, 352677332, 2297720250, 60907813, 90501309, 3286998549, 1016092578, 2535922412, 2839152426, 457141659, 509813237, 4120667899, 652014361, 1966332200, 2975202805, 55981186, 2327461051, 676427537, 3255491064, 2882294119, 3433927263, 1307055953, 942726286, 933058658, 2468411793, 3933900994, 4215176142, 1361170020, 2001714738, 2830558078, 3274259782, 1222529897, 1679025792, 2729314320, 3714953764, 1770335741, 151462246, 3013232138, 1682292957, 1483529935, 471910574, 1539241949, 458788160, 3436315007, 1807016891, 3718408830, 978976581, 1043663428, 3165965781, 1927990952, 4200891579, 2372276910, 3208408903, 3533431907, 1412390302, 2931980059, 4132332400, 1947078029, 3881505623, 4168226417, 2941484381, 1077988104, 1320477388, 886195818, 18198404, 3786409000, 2509781533, 112762804, 3463356488, 1866414978, 891333506, 18488651, 661792760, 1628790961, 3885187036, 3141171499, 876946877, 2693282273, 1372485963, 791857591, 2686433993, 3759982718, 3167212022, 3472953795, 2716379847, 445679433, 3561995674, 3504004811, 3574258232, 54117162, 3331405415, 2381918588, 3769707343, 4154350007, 1140177722, 4074052095, 668550556, 3214352940, 367459370, 261225585, 2610173221, 4209349473, 3468074219, 3265815641, 314222801, 3066103646, 3808782860, 282218597, 3406013506, 3773591054, 379116347, 1285071038, 846784868, 2669647154, 3771962079, 3550491691, 2305946142, 453669953, 1268987020, 3317592352, 3279303384, 3744833421, 2610507566, 3859509063, 266596637, 3847019092, 517658769, 3462560207, 3443424879, 370717030, 4247526661, 2224018117, 4143653529, 4112773975, 2788324899, 2477274417, 1456262402, 2901442914, 1517677493, 1846949527, 2295493580, 3734397586, 2176403920, 1280348187, 1908823572, 3871786941, 846861322, 1172426758, 3287448474, 3383383037, 1655181056, 3139813346, 901632758, 1897031941, 2986607138, 3066810236, 3447102507, 1393639104, 373351379, 950779232, 625454576, 3124240540, 4148612726, 2007998917, 544563296, 2244738638, 2330496472, 2058025392, 1291430526, 424198748, 50039436, 29584100, 3605783033, 2429876329, 2791104160, 1057563949, 3255363231, 3075367218, 3463963227, 1469046755, 985887462], 
    };

    expand_key(&mut state, &salt, &key);

    let expect = State {
        p: [2416368460,2114864945,2794836527,384732410,3689144708,270463106,3008129635,1470627110,2412575379,2058440715,2059316275,803469545,3085651629,1977952169,2520253219,1804915078,2593281369,1479382479],
        s0: [1384318337,95953624,1992043918,4192289418,2445217862,3915313852,1640211117,3436076652,3251929690,1819328887,959813384,1884471307,2425651567,2021458816,2230006469,2054209087,900055946,1296135458,1268430387,152528457,2213742095,2694488234,937128501,530984678,786845232,1535913909,1107693658,2867978136,1055924503,1155781504,2426452404,3669559352,3561773722,310524008,1206218983,2021517524,1840643655,2497515743,4166686712,224981281,3636643173,2472751754,1626935566,900979637,1291778101,944844532,2609825489,405349108,1740803588,1141104970,2324378448,1820563978,765046336,3516241165,2130985128,2876853761,4180704709,3388104961,1520987145,1750326279,1548080127,191405550,1992895869,3454211319,3387600678,2500325121,2395887775,2052111674,3501990351,2931317633,4178635979,3756917681,1338910119,4052941818,2879355854,1340591956,3199833381,1043198584,1082073425,1704131503,942812487,1883013110,4160472674,3941145787,1125417151,1425551938,2022915633,737406786,2763073523,656951520,982821605,1923909680,545846900,2582464941,685682561,3455209340,1590398950,1195733499,3762579319,24373813,2679243445,3012166437,2602860186,3334539965,3815689268,35898759,2585662913,2192783795,1763455600,3981784349,68772272,2869379142,830312552,2279107741,2184569559,1621234197,4293140583,70961656,2467250655,2383420631,2054650446,141668693,2986071155,3838010424,821745240,4138114670,146316961,1925177225,2415135680,3014785377,3812032550,3311432603,309685658,1179848681,2654703577,507893512,294581503,626791280,2598871396,2786064777,918376658,2745241361,1051554614,3047546471,3520167972,2361295374,614763266,1924777838,990336374,2096494262,1603570910,175615092,2136247588,159163186,3274422158,3945957045,2897178833,2176047847,4234765914,3428450031,3791885350,1497181512,556656399,2391058207,1223762862,2284635856,1600940670,1880557728,1783671114,1208705104,2495494724,1103216888,1314122546,55089325,2521205621,1271272520,2836444936,2755919225,828389473,2686983762,2346760355,253722401,1921323919,2366145176,3837500454,2541337421,1483042354,3997821956,1733628336,2248575622,3337926218,4035751364,4233092408,4226785501,2370472389,250673408,678235761,44039722,2311121913,4186529826,4009046343,195914616,2050352935,1486102375,300886116,1425815000,2830254888,2758974329,1158190326,3096916541,970254311,2595870327,2183300812,4052425101,3395173235,2235970812,1213831818,1919569723,981095174,3711670425,486765740,3831038905,838887167,1898175159,3028792702,2708407763,2326291247,1042382408,4066536197,2252077374,1096007728,2972840314,411341663,3759288596,3572147365,3106646673,818309636,4202519385,88783213,2751483698,3138869143,2691196927,1320397939,3496781575,355798147,3101450785,2654857293,3481997866,2233658786,1478875398,1194814890,3713347806,1918273737,3985556283,2091582499,2009488854],
        s1: [896018366,2460538737,3021949892,2309302984,2142071351,2132805246,1226783686,2475598251,1210126776,4247713702,1116934010,363673571,2929348389,1589980441,3014076782,1342770592,801071739,2129567379,3703811830,2443589009,2159657357,2471366254,560423520,3422525671,1850266753,1368663239,2446110870,1543641091,1246433741,3259438822,2256444878,2041068155,156551880,2855226770,234456740,524176468,3360764180,1679817032,3864956179,1410608388,2244692412,612345937,2041427765,904212285,3155444188,3021254563,862022448,3258350874,874567563,3580553983,412694816,1946101826,472767834,2777805846,4292209611,251143047,3952607263,869602627,1489334632,3290781826,387010264,2002468630,1077398577,2277191856,3167094720,382745717,3732497561,1150182159,2768296587,1062104541,4281606043,2514668480,836590330,741752575,1159622104,2003219099,622420474,2864351499,960846,2063802311,2195572729,1445012096,4128738435,1468968932,4172102500,3171445871,4036010712,2085152480,1938242648,3627261754,1799217849,3097878632,1224090654,1979337457,1293281632,2424597600,4158264476,497004783,2823017427,1497078855,2646924362,2987068061,2376495904,1626240757,4195511987,2450402656,2622931414,2510261443,138050592,132356497,982964860,57814538,2086993573,4054030175,1919458229,2583513325,1843803526,2095676763,3103567603,220188359,1320641787,3315311633,752592725,3855289365,1973369364,1687007419,2684968173,996254126,2456298008,2601515199,1750713058,1813497339,3376857930,267978013,166138074,4211628633,2161601222,187367543,1555479091,1247658421,2859550709,1643173476,1723801422,263651391,136705177,3524129436,1515116023,2029496558,2933977861,1215671017,183062419,953771245,2828896778,865036,2126626365,1373876985,1010966038,2663938260,3510342784,980224962,167473930,960513262,13780948,2283192799,361102149,2811988198,1097864980,2459647484,3683193996,138323874,906943311,1402011965,1734189189,2537666109,1004660857,2129540480,75892175,3938620530,3432318435,68440662,3754999176,835631378,685767175,2525012025,1793939065,2357471028,930209521,1206798238,3899445654,282181772,227944280,3338655459,3724960426,911659729,3286771185,183867402,3209281688,3422145157,46572684,67510501,959611377,2238541693,3857088965,652743726,2013816136,1807462326,3550575231,4183361626,187309956,3919012396,1392662386,563748755,1759024053,37855985,2257180440,3383042962,1913528481,2924851747,558395976,2045199521,1787772430,2877955397,1497465174,1151300843,2929938101,2814249993,880526890,679405019,1965962107,3903888525,1552729454,184709243,2050062634,3148337790,1834460247,720893330,2616867000,3880488908,1057716476,4053666463,681294957,3504165929,418427382,2237357095,3502901987,539590891,700796331,2961698590,2682419244,791047131,3473245125,2114945905,3806190005,634812208,451464342,3641932756],
        s2: [2954903495,757877034,384082536,3368333325,1462654258,704695154,3108049247,2193696540,236056047,88029798,460956957,2946949248,2364533934,2958876702,4194258134,3493722730,115579738,569606801,3713831562,2155473384,3198548237,4221766585,1888665641,3726620297,4279008538,1123184956,3413754962,28724140,4119393746,485736229,825159129,2566539631,578452827,4210786371,243819744,446852008,2456925724,1231633659,1066391412,996717447,272755669,1338858257,3648753338,1673831715,3422350593,2795722767,849198645,2949501863,3159941,2101519451,3185681938,70667619,3965944602,1092288583,241074023,4113476777,3847623508,684291153,1470312885,4143429800,1697993204,1158432481,2648552877,3197583835,2857276707,836828541,3247278012,1628927873,3919486430,408885129,721135085,2289727952,3674642688,4092185229,661183489,2072690335,2857667365,285861124,3941499134,1191976707,1492933175,2491996571,3629371100,528609753,2978797989,3843084625,1050323469,2548796006,3838619064,3104530692,1261649424,2120711078,2853860901,3872122936,1691054145,1741595780,965083851,3115130159,2283823170,1011202178,1753053390,393213801,624409016,40687002,4293524438,3583254306,234010054,1333449006,727969654,1831388104,4046819036,328295991,592717052,2286818625,2953206308,2094978834,2400958630,1575420857,2437203038,3405684829,2076394398,1898233201,3422105632,867410515,519970184,3819010857,3542493969,1509097835,2297650471,4122424187,1822714084,2370877543,482436072,226363793,3047484946,3384321078,1819401057,1371635858,3971850949,3220349089,1039725868,792726491,907632865,1222444380,815244577,533403618,1627118871,1521386311,3849936759,3650937036,81545556,3657074619,3792993925,1655354267,3934431365,3132167030,1795397405,4264767480,1796528496,66401006,1616020236,1104553613,2505483371,804043514,3848058057,3599430338,2544612882,1231623156,1762755894,1295197759,615844847,2719452497,1384506169,4031865975,695427304,351966007,3158145608,3818752478,531771378,2535601377,2372651968,2310042049,1712855588,1819136087,4247794927,1727455639,985117010,1494733879,1466589705,174533954,1657123927,2962223029,3194406360,844262152,35605738,2761998035,3320098373,2523071516,1176050696,3282794733,300814704,1602575286,2024028542,2968124289,4092621051,3779120896,739537561,3922896561,954705699,1555043890,2295846159,2891291124,289023865,1432677186,3950526061,863043435,1328179178,2326272896,3900378342,2793293865,2041530662,1281561272,4069206802,3415085098,2109098680,3544197496,867801099,3839632925,4077057653,2919686972,2116376333,914236367,780432183,2218308212,809068188,3283789610,3159403184,590072642,1084731125,2372382861,202463806,2747030674,3482248306,346438866,1976683059,1202173217,2005683292,2960181030,4056779573,3801304898,2947680457,774340452,2444247630,4184559918,2961124574,2362125279],
        s3: [3576745299,2769182175,655244327,1802052558,2621018045,1184368880,3267682544,3800928156,3692242509,61558041,221013302,777512312,417259756,780634635,304604014,2738513515,736442177,2494761143,3146866189,1709961737,667395209,1383018247,408903013,1686164815,2867883869,715015395,2410479796,3651815900,4182822566,1885914007,2895786088,4084173834,4103887024,2030312540,418469254,2335962121,1634355388,1754348036,2221398090,186980511,4121097838,1301632308,2888031895,441636235,3264429883,3934051042,2026789563,4008561401,547860283,151049103,2143066995,1961011871,1214357018,1845649449,1646965447,1772829489,2914331576,122423917,1130018547,469290034,3063935454,2674362974,3708338649,1788329309,2256323853,3548397302,2085992099,2345158647,2366992953,1674453095,3207482294,1879684832,3683771173,232577293,1361692092,2775506325,1025656703,4229375284,1370310296,2439082274,2359731351,2564136114,3819313796,2628218360,1513280400,1602769355,1762893085,845498561,3924308218,1598359977,2107898718,2239498949,2440437600,1297757152,720365771,3189163382,77211024,720709922,1235023986,184548340,172950980,860613368,145500248,3410880487,2062390551,3130264047,1318323533,3748497703,342967461,1815093837,4187408508,3654123369,3387741681,544559423,98596469,3924631912,187518702,859095637,4107191663,604306780,2147050303,2328450655,3790238091,3136194258,1858578559,95210026,217642260,3429612581,2858605152,1810156470,4161571318,3366349882,1874483515,514109939,256059368,1896026373,1124044707,477475707,3106069626,873002959,3720475622,3786136809,2914911278,1918538003,505571457,1201892102,624702871,1930864395,3409780173,2477028224,3099908393,4169671951,4008400322,1900152610,3416966256,3686593492,3479692680,3048884517,3186303400,1169592029,1475151752,2602872723,4004370824,1128070244,2569706022,3869607358,4238938341,3876968340,2730992535,245880115,1529305253,578881297,3747790565,2778998955,3294630632,779264205,2852987193,2610004033,1057945176,2785625290,1595296228,3294692925,119301493,3989971290,2929651146,3002009458,111003704,2480229794,1252041467,4021809277,2967701651,574328795,3808003726,185996598,2249130361,3803194112,3701423076,2863259806,3664668959,3115140339,1389819107,568673301,3684400767,346687688,3239718579,2209770833,2283772580,3748033709,67013551,443922755,1275740681,1881901453,3310566688,3537763509,3612072795,3034782239,473300913,4257144496,458559712,2227730621,1310103422,475266397,3916163026,2640022654,482723689,4137545565,2245851757,2765310274,3202276462,1151349256,1767774652,2521538362,3119575999,3308007612,1213372352,1263946992,4096202659,3123581026,2153300826,1809058270,1417135947,4231198054,2009384057,4157283154,2244535242,2278576153,1124070952,473740174,2272689301,2982897392,3040660262,1737647772,193352213,3841002015,1303784951,492923392],
    };

    assert_eq!(state, expect);
}

#[test]
fn test_eks_blowfish_setup(){
    let salt: [u8; 16] =  [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15];
    let password = "password".as_bytes();

    let key = [112, 97, 115, 115, 119, 111, 114, 100];
    let cost = 5;
    let salt: [u8; 16] = [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15];


    let state = eks_blowfish_setup(5, &salt, password);

    let mut expect = State {
        p: [2243764582, 3479743965, 3288408921, 2280578625, 3833415586, 3446352354, 242763813, 1796410443, 1086185686, 2571780537, 3526243866, 3159693173, 561060827, 1655262023, 583960577, 3796564418, 4087524337, 4183382549],
        s0: [2533275238, 190556162, 3920126864, 2239227349, 877867988, 2150202058, 191750414, 1576003560, 722842080, 3292711528, 3878368140, 2560482872, 2233562054, 3056604467, 2949912236, 2643381840, 730615736, 2760767003, 3916545796, 1731826835, 2419055002, 2454699031, 1211237904, 3127416061, 1029635804, 2532055728, 2679798337, 793494037, 3212386276, 1743270057, 2961634218, 1474212813, 1937306861, 3636343881, 2803086897, 3652356503, 3383157286, 1711390126, 52793684, 1723377390, 3651253550, 1963772719, 516241853, 3874482212, 649233583, 4049186170, 1575216134, 920021469, 3039949898, 2704827211, 3036803534, 4196225642, 2533498137, 129896272, 4290861880, 4277496529, 39846580, 3342746969, 23487043, 393032908, 3927778164, 4055664972, 3889241978, 198409918, 170611337, 4165485417, 2361561324, 4119012537, 1909823207, 4225936811, 2103785117, 3349155547, 2765920335, 691689594, 2632334581, 700619453, 2855157463, 3132977669, 2717832248, 2450767935, 397636106, 3799019045, 1906900883, 4173454313, 1166187502, 1636031547, 4286919008, 297575278, 2827729218, 3210426506, 1312733682, 3804369704, 3503864457, 676701865, 2133052822, 1786197090, 2488773589, 3788612205, 420161617, 1922668362, 3353378436, 1834855383, 3092356071, 1796483301, 2033925474, 3831381765, 2625205846, 1358154090, 971469013, 2733309980, 1727810150, 1584379800, 2140081955, 370740057, 490168735, 875991833, 2968790911, 839331079, 402139614, 4231172118, 1766689893, 1018072809, 3199835875, 4117996939, 4206200587, 4237270013, 202600281, 3526335324, 2908526259, 716444727, 2784295408, 2308574719, 1457777442, 467842448, 3056521666, 560559761, 1396003173, 533571511, 1986782990, 1881128468, 1948438280, 1377590628, 3237029175, 3935345711, 2287205983, 831882730, 1316915416, 29066092, 2909787487, 2215615784, 1148601028, 1735066514, 4037500815, 2082859232, 891769432, 2182307283, 3586240386, 396697037, 460877797, 2136781012, 2562473117, 1574556401, 3579396411, 363304576, 402122966, 3027230547, 3212092169, 1467023194, 2088088398, 2004260547, 3663426014, 2664480705, 3944608509, 49726617, 3597897060, 97754472, 1286168985, 3858762250, 1554430182, 2112837675, 467173997, 444307016, 2787568033, 1401597647, 319663211, 438089031, 3968923837, 2536658203, 2662821459, 3708421800, 3557888586, 44595237, 648664324, 4149009478, 2397270873, 2352499002, 3556025652, 4260720739, 594438565, 3435312754, 621568181, 954711480, 1347955002, 3349828488, 220329285, 1421142722, 4137072091, 330684570, 4089356942, 942642675, 101914844, 754714764, 3839595227, 1173724044, 239334432, 1572633561, 37684640, 27874067, 93707740, 1084355199, 620446884, 2664839606, 486752136, 2032983066, 3182707136, 2988300030, 2463527959, 2454726004, 4135109511, 3948152002, 775684828, 3361083169, 2429471792, 849368966, 2258594774, 192276660, 1067792119, 2303261868, 2368407293, 4123940457, 3779888040, 4036329852, 3675082106, 1189777518, 1536568303, 1352427486, 2028460905, 3658322184, 2246366089, 3776240472, 2735453449, 506196633, 2533334588, 3745915006, 1393148921, 3689681067],
        s1: [3712151683, 3227599443, 2053833734, 2342228144, 1854893272, 2807345005, 4285639066, 1789198192, 3674403779, 3755727275, 176969522, 2912335719, 1557752035, 2982468973, 1039012282, 4239337959, 1258223060, 3060469360, 2973716358, 593903220, 4126269818, 2759395778, 3575927694, 1396811749, 1603734928, 3676429968, 1836883468, 1257959438, 3064499122, 854872528, 1322435320, 2782007612, 2347997769, 79318681, 1512662514, 1597126304, 4203837791, 4118352585, 3614527149, 2142729339, 3126796026, 3612976339, 1778206595, 1104147692, 2613126708, 4159293638, 2012110184, 76542949, 2696951796, 1806937252, 2678131718, 2118418026, 349836303, 2544720758, 2842061520, 24766147, 1691337824, 3539317204, 2952397075, 138080854, 3900699846, 3510073181, 2409018274, 2322654429, 2196808567, 1775427260, 202946492, 2596397924, 1527362442, 3534366616, 3902343120, 1491226911, 441118576, 1353143256, 1558411987, 1681339834, 2524469403, 3560999595, 2214197840, 1521881886, 841676379, 2390190157, 2276568522, 4114616128, 3404161767, 2031889190, 524110768, 2192335949, 842541518, 2346386440, 3958395499, 988622141, 1335771894, 416644984, 3820526888, 957124049, 1385948920, 81602658, 1311971102, 1007306711, 4037755285, 1693055185, 2551701612, 2352893102, 1698428827, 3751014494, 3436631801, 3549270262, 2608724639, 3503704842, 2265134320, 2066405064, 138141617, 448207164, 2484437141, 2249041984, 2730342633, 3981584746, 762370363, 4001691636, 3521648103, 2318771417, 2359922944, 3258042228, 1810221163, 337191968, 3607821394, 2523921401, 444796169, 1183716729, 793655777, 670692633, 1792367076, 4048095279, 2231983405, 293460172, 6847634, 1431583222, 294324179, 789518855, 1902952443, 611667214, 3907061413, 1936424541, 2227649484, 1537212055, 145382340, 1834875830, 817154093, 1688831808, 1465088553, 201675335, 2524409652, 2934682710, 1917825451, 166288174, 805414949, 3633400596, 945573045, 110344523, 1025856658, 4010663114, 3827677094, 4080580633, 4194038218, 1893248774, 1091198968, 4234512134, 3710660543, 375594744, 1879379782, 615669132, 2381238494, 2291306181, 642071501, 2243717086, 3958596411, 3553763971, 2966404224, 2914369894, 3288548434, 1126026384, 4147903553, 3425185816, 2706033417, 3456229771, 2793008589, 1755665903, 1839940571, 3475938166, 640565229, 1045733865, 683873915, 1016919681, 1566841433, 3056712099, 2594372295, 3963613492, 1522135327, 3150319964, 3885472696, 1174627211, 3036461960, 3824842864, 4013908248, 290719378, 3850481759, 4046192159, 3933866309, 214367837, 2167596036, 1984029084, 195429243, 1974283143, 2021392655, 2143613046, 800291973, 2482842436, 1498345116, 163416125, 3235690714, 866293141, 401489048, 3247694563, 1184912905, 1788967953, 277577509, 297890262, 3780194462, 3575367898, 2853257422, 1580756706, 1204109507, 3104303087, 1651463957, 3068534117, 2158882725, 2630169971, 1155186566, 4284210584, 1171849624, 4183282185, 2232157624, 2793820622, 3139047731, 1824972521, 3452089685, 1707632101, 3118035216, 1692996655, 3979981756, 4148782069, 2210404853, 14912832, 512786245, 1307491754],
        s2: [894022853, 3367113296, 780652219, 770369804, 203142798, 805142823, 2333942062, 1866323692, 2634617522, 407951708, 1553147764, 2922490935, 1080178199, 3282557204, 2879120100, 1033288233, 59842795, 2409638111, 4185781537, 4196159539, 1271775941, 3453333648, 3167511666, 1723551500, 3434504149, 1426352608, 1346937149, 1164072397, 2459472171, 2076915671, 1297129725, 3522522332, 2353139849, 4008589773, 942972232, 3681687181, 837174078, 2131432686, 260176069, 2511018920, 1117496374, 4043276362, 1201737065, 2897888633, 1385945742, 716179393, 2476780079, 1297948554, 819129696, 4214476243, 886764589, 2072628373, 2614395522, 489715870, 3127590017, 1168202209, 1494186457, 2845818621, 2687664644, 482462919, 1940560046, 3414704333, 3207196202, 134161447, 3760883674, 1143365128, 852209021, 2489644079, 786497488, 1733891711, 2471480320, 744935261, 722442571, 3556105325, 2609393728, 3376683058, 736777435, 1419789197, 654488262, 1021573795, 3236056248, 1563606546, 1956246703, 2510312164, 3192159248, 1869644850, 3161917558, 625168251, 3465494538, 3014892249, 3069319137, 320198235, 2104490529, 2489867517, 3223147897, 3344813256, 1466911006, 465820067, 448598995, 1055476411, 235079236, 631447634, 1965402250, 2944293015, 3112013938, 3895610353, 3481724400, 3235549851, 1818702231, 137557293, 1485334231, 2306659574, 1583750166, 3882335, 1751365093, 2645337067, 2738581354, 3636388994, 1200444708, 3623338542, 531406223, 3083774393, 1469166229, 4072645815, 2854142402, 315014432, 2482651349, 563091470, 2351637558, 2875383326, 485063089, 169896070, 84520080, 3355244984, 3984724357, 1349884415, 2283756587, 1560742531, 2225299104, 275353359, 2076490279, 944344561, 3311797092, 4226004645, 383767084, 1642770072, 1687184143, 3997855090, 677323108, 690739177, 1032299416, 2499470413, 110102382, 4046114471, 4186271499, 1599030073, 188625643, 3473362798, 1181171299, 4183265347, 3364649902, 3829670582, 881402975, 1743310377, 40985135, 713333940, 3872600613, 2325356756, 1705721067, 3463156332, 1204459117, 2032407137, 1747531112, 2460990234, 3370986400, 1640198716, 2756564438, 3648406104, 991768735, 1165184013, 65298936, 2217153392, 1716706425, 2109308905, 3688898412, 754648972, 2546475813, 4043159756, 4036839309, 3377191936, 493211371, 2279062835, 1548436671, 2825812989, 2631991423, 2045614918, 2459507610, 696019128, 420414921, 162309171, 3275343787, 1578020951, 222742886, 1694512833, 354206345, 4152517164, 2072161277, 209602911, 136461408, 3674457060, 2070262888, 2705690782, 777864346, 2353869944, 58073567, 3355568150, 271920374, 1591815366, 876908927, 1461632368, 2247383152, 150981259, 1369329700, 2854858495, 1275465597, 3603076644, 3803822665, 3060545251, 831986713, 2497401993, 4081474927, 805694961, 1400258313, 2540374566, 278277632, 626885285, 764478392, 2476254956, 2841249486, 2233874415, 2799445775, 2560078178, 57058051, 2569700569, 3636234343, 915325422, 1142835614, 2705169490, 887904029, 99573838, 237558516, 1140847502, 3307839040, 2436789713, 3974420941, 1750134425],
        s3: [3901223375, 1506161117, 2414884919, 3414574502, 948316185, 4060546028, 1199628944, 1336695709, 1222238281, 2754876631, 3377621976, 1078792648, 1768702459, 2618075382, 1157320464, 2397736861, 1352886706, 1578194280, 3707247568, 4168250763, 1386411275, 3426870476, 267825596, 2591217962, 3559794427, 153280136, 3696857550, 3239071905, 708912058, 3698203485, 3905226, 561200045, 1088507646, 2150232616, 2074425714, 3914974013, 981149123, 3526723372, 1939180327, 3885758620, 1162148689, 3090223374, 1500836556, 3221241921, 1010671481, 3516256912, 2701490133, 1430222236, 867621189, 617165922, 3976606852, 3361981022, 1507571366, 731775843, 984844971, 4142309691, 1790832621, 3803667501, 1068781753, 4249832050, 3366845518, 777012118, 3158939838, 2877470833, 2440857331, 4210592147, 1561062015, 2543797453, 2398628775, 2489136929, 1713614336, 1675126483, 2454624507, 2809575912, 2623300611, 2716580725, 4182842798, 2670796932, 3846581573, 541801369, 1015790109, 896350034, 1153654699, 2304736072, 926036550, 3965349353, 3363302083, 530883016, 2547471939, 1213368752, 1657454190, 238372659, 2338466319, 640171615, 1953496400, 1985019947, 998460114, 1280319156, 711378304, 218235155, 2947929558, 790612648, 2870423704, 253443392, 2566775402, 181557128, 3703821098, 1762876119, 1516768916, 1844124144, 80276630, 2528140552, 4234213987, 2768569108, 2557440250, 781268950, 3160737630, 3801754857, 786587433, 1260395203, 533007980, 2596192578, 467537153, 1018025470, 3071911481, 1867605919, 430074812, 1470253820, 2013283845, 3578665663, 366543578, 2656126391, 3598190804, 2058849720, 1698693975, 2608816459, 1458905962, 1098468074, 4280003448, 2732810172, 520239063, 631802919, 2619395932, 1302192287, 787226155, 292661482, 1909912472, 3207175501, 571027228, 1802689731, 2443681904, 2033255416, 2564568877, 2148933411, 1471862598, 1984833972, 700465228, 3473390223, 1769537061, 2529957744, 3386381589, 1380666471, 3172562385, 2160402698, 1169076436, 604473714, 3184605106, 2373811991, 3770666452, 3949388103, 4265799210, 2452907764, 413137587, 133397739, 3276725868, 3382094554, 2540443698, 2584337730, 318555472, 935284161, 1877879169, 943181107, 3680200171, 19103910, 2718170153, 3292183974, 2873189121, 2371992234, 1240959405, 1169289309, 2656327272, 1185726131, 1268805115, 3776131687, 3188768912, 1285021468, 4280602172, 1648592245, 2640904675, 1757565963, 4172911435, 3164525446, 3347391, 441795764, 3589795670, 76214251, 4237485004, 2243131658, 3283379700, 3224771869, 2527210698, 1672490417, 3930573909, 2823235327, 2774969955, 2965379342, 683643976, 3986713370, 2255362921, 3764554116, 3146698329, 1377091890, 1932782409, 2226629759, 3933825968, 2146134288, 155619185, 540484547, 1946203318, 2131687061, 229870412, 1293392213, 2286524247, 4216756895, 2656453342, 2724510670, 2835529067, 523399928, 2471301227, 644295281, 1888909242, 170144947, 2152602915, 514597795, 3705132235, 2085515991, 4127849927, 3043622118, 1341772198, 3949664565, 3758109969, 3028324762, 583367439, 408378102, 1736012565, 2254738037]
    };

    assert_eq!(state, expect);
}